<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HealthAndHIT ‚Äî Shop (Inventory Enabled)</title>
<meta name="color-scheme" content="dark light">

<style>
:root { --bg:#191a1e; --panel:#23242b; --card:#26272f; --accent:#ff3939; --accent-2:#ff6b6b;
  --text:#ffffff; --muted:#c9c9cf; --ok:#48c774; --warn:#ffb020; --bad:#ff4d4d;
  --radius:16px; --shadow:0 8px 30px rgba(0,0,0,.35); }
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}

/* >>> SCROLL LOCK PATCH >>> */
html { overscroll-behavior: none; }
body.scroll-lock{
  position: fixed;
  width: 100%;
  overflow: hidden;
  top: var(--scroll-lock-top, 0px);
}
/* <<< SCROLL LOCK PATCH <<< */

/* Header */
header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#1d1e23 0%,#1a1b20 100%);border-bottom:1px solid #2f3038}
.wrap{max-width:1160px;margin:0 auto;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:42px;height:42px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#ff6b6b,#ff3939 60%,#b70000);box-shadow:0 0 0 3px #2a2b31}
.brand h1{font-size:1.25rem;margin:0;font-weight:700;letter-spacing:.3px}

/* Basket FAB */
.basket-fab{position:fixed; right:18px; top:18px; display:flex; align-items:center; gap:10px;
  background:var(--accent); color:#fff; padding:10px 14px; border-radius:999px; box-shadow:var(--shadow);
  cursor:pointer; z-index:60; border:0; font-weight:700;}
.basket-fab .count{background:#000; padding:2px 8px; border-radius:999px; font-size:.85rem}

/* Hero notice */
.hero{padding:18px 16px 8px}
.hero .notice{background:#1f2027;border:1px solid #2c2d36;border-radius:var(--radius);padding:12px 14px;color:var(--muted)}

/* Product grid */
.grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:18px;margin:16px;align-items:stretch}
.grid .full{grid-column:1 / -1}
@media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:980px){.grid{grid-template-columns:repeat(3,1fr)}}

.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
  overflow:hidden;border:1px solid #2c2d36;display:grid;grid-template-rows:auto 1fr;height:100%}
.media{height:180px; background:#101015; display:flex; align-items:center; justify-content:center;}
.media img{width:100%;height:100%;object-fit:contain}
.card .body{padding:14px 14px 12px;display:flex;flex-direction:column;gap:10px}
.title{font-weight:700;margin:0 0 4px}
.price{color:#ffb923;font-weight:700}
.muted{color:var(--muted);font-size:.9rem}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select, input[type="number"], input[type="text"], input[type="email"], textarea{
  width:100%; padding:10px 12px; border-radius:10px; border:1px solid #343542; background:#1f2027; color:#fff;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-accent{background:var(--accent);color:#fff}
.btn-bad{background:var(--bad);color:#fff}
.btn-block{width:100%}
.small{font-size:.92rem}

/* Quantity stepper */
.stepper{display:inline-flex;align-items:stretch;border:1px solid #2f3040;border-radius:10px;overflow:hidden;background:#171820}
.stepper button{min-width:34px;border:0;background:#20222a;color:#fff;cursor:pointer;font-weight:800;line-height:1;
  display:flex;align-items:center;justify-content:center; user-select:none;}
.stepper input{width:64px;border:0;background:transparent;color:#fff;text-align:center;padding:8px 6px;appearance:textfield;}
.stepper input::-webkit-outer-spin-button,.stepper input::-webkit-inner-spin-button{appearance:none;margin:0}

/* Drawer */
.drawer{position:fixed; inset:0; display:none; z-index:70}
.drawer.open{display:block}
.backdrop{position:absolute; inset:0; background:rgba(0,0,0,.45)}
.panel{position:absolute; right:0; top:0; bottom:0; width:min(520px,100%); background:#1b1c22; border-left:1px solid #2b2c33;
  display:flex; flex-direction:column; height:100svh; max-height:100svh; overscroll-behavior: contain; }
.drawer-content{flex:1; min-height:0; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:0 16px 16px;}
.panel header .wrap{padding:14px 16px}
.section-title{padding:12px 0 0 0; font-weight:700}

/* >>> SCROLL HINT PATCH (CSS) >>> */
.scroll-hint {
  position: sticky;
  top: 0;
  text-align:center;
  font-size:1.35rem;
  line-height:1;
  color:var(--muted);
  opacity:.7;
  animation:bounceArrow 1.2s infinite;
  user-select:none;
  padding-top:6px;
  background:linear-gradient(180deg, #1b1c22 0%, rgba(27,28,34,0) 90%);
}
@keyframes bounceArrow {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(6px); }
}
/* <<< SCROLL HINT PATCH <<< */

/* Lines */
.cart-items{display:flex;flex-direction:column;gap:12px; padding-top:10px}
.cart-line{display:grid;grid-template-columns:1fr auto;gap:10px;border:1px solid #2b2c36;border-radius:12px;padding:12px;background:#20222a}
.cart-line .meta{font-size:.9rem;color:var(--muted)}

/* Totals */
.totals{border-top:1px dashed #353644;margin-top:12px;padding-top:10px;color:#ddd}
.totals .row2{display:flex;justify-content:space-between;margin:6px 0}
.totals .grand{font-size:1.15rem;font-weight:800;color:#fff}

/* Delivery method segmented control */
.seg{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.seg button{flex:1;border:1px solid #3a3b47;background:#1f2027;color:#fff;border-radius:10px;padding:10px;font-weight:700;cursor:pointer}
.seg button[aria-pressed="true"]{outline:2px solid var(--ok); border-color:#2a3;}

/* Discount row */
.discount-row{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
.discount-row input{flex:1}

/* Sticky action bar */
.checkout-actions{position:sticky; bottom:0; inset-inline:0; background:#181920; border-top:1px solid #2b2c33;
  padding:12px 16px; display:flex; flex-direction:column; gap:10px;}
.gate{border:1px dashed #3a3b47; padding:10px; border-radius:10px; color:#cfcfe5; font-size:.95rem;}

/* Acknowledgement (now in scrollable area) */
.ack{display:flex;gap:10px; align-items:flex-start; background:#1f2027; border:1px solid #2c2d36; padding:10px; border-radius:10px;}
.ack input{margin-top:3px}
.ack small{color:#cfcfe5; line-height:1.35}

/* Popup + toast */
#discountPopup{position: fixed; inset:0; background: rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:999;}
#discountPopup .box{background: var(--card); padding: 20px; border-radius: var(--radius); max-width: 320px; text-align:center; box-shadow: var(--shadow);}
#discountCloseBtn{margin-top:10px; padding:8px 14px; border:0; background:var(--accent); color:#fff; border-radius:8px; cursor:pointer;}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%); background:#000b;border:1px solid #333;padding:10px 14px;border-radius:10px;z-index:120;color:#fff;display:none;cursor:pointer}
.toast.show{display:block}

/* Confetti canvas */
#confetti{position:fixed;inset:0;pointer-events:none;z-index:200}

/* FAB bump */
.basket-fab.bump{animation:bump 300ms ease}
@keyframes bump{0%{transform:scale(1)}10%{transform:scale(1.06)}30%{transform:scale(1.12)}100%{transform:scale(1)}}
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<header>
  <div class="wrap brand">
    <div class="logo"></div>
    <h1>HealthAndHIT ‚Äî Shop</h1>
  </div>
</header>

<button class="basket-fab" id="basketFab">üß∫ <span class="count" id="basketCount">0</span> <span class="count" id="basketTotal">¬£0.00</span></button>

<section class="hero wrap">
  <div class="notice">üî¥ <b>Now Open</b> ‚Äî Per-size stock is live. Add items, then tap the basket to checkout.</div>
</section>

<section class="grid" id="productsGrid"></section>

<!-- Drawer -->
<div class="drawer" id="drawer" aria-hidden="true">
  <div class="backdrop" id="drawerBackdrop" tabindex="-1"></div>
  <div class="panel" role="dialog" aria-label="Basket drawer" tabindex="-1">
    <header>
      <div class="wrap" style="display:flex;justify-content:space-between;align-items:center">
        <strong>üß∫ Your Basket</strong>
        <button class="btn btn-bad small" id="closeDrawer" aria-label="Close basket">Close</button>
      </div>
    </header>

    <div class="drawer-content" id="drawerContent">
      <!-- ‚Üì arrow hint (sticky at top of scrollable area) -->
      <div id="scrollHint" class="scroll-hint" aria-hidden="true">‚åÑ</div>

      <div class="section-title">Items</div>
      <div class="cart-items" id="cartItems"></div>

      <div class="totals">
        <div class="row2"><span>Subtotal</span><strong id="subtotal">¬£0.00</strong></div>
        <div class="row2"><span>Shipping</span><span id="shipping">¬£0.00</span></div>
        <div class="row2" id="discountRow" style="display:none;"><span>Discount</span><span id="discount">-¬£0.00</span></div>
        <div class="row2 grand"><span>Total</span><span id="grand">¬£0.00</span></div>

        <!-- Delivery method (FREE local pickup/delivery by default) -->
        <div class="section-title">Delivery method</div>
        <div class="seg" id="deliverySeg">
          <button type="button" data-method="local" aria-pressed="true">Local pickup / delivery ‚Äî FREE</button>
          <button type="button" data-method="post" aria-pressed="false">Standard post ‚Äî ¬£3.99</button>
        </div>

        <!-- Discount -->
        <div class="discount-row" style="margin-top:12px">
          <input id="discountCode" placeholder="Discount code"/>
          <button class="btn btn-accent" id="applyDiscountBtn" type="button">Apply</button>
        </div>
        <div class="muted" id="discountMsg" style="margin-top:4px;"></div>
      </div>

      <div class="section-title">Delivery details</div>
      <form class="form" id="checkoutForm" novalidate>
        <div class="grid">
          <div><input name="firstName" placeholder="First name" required></div>
          <div><input name="lastName" placeholder="Last name" required></div>
          <div class="full"><input name="email" type="email" placeholder="Email" required></div>
          <div class="full"><input name="phone" placeholder="Phone"></div>
          <div class="full"><input name="addr1" placeholder="Address line 1" required></div>
          <div class="full"><input name="addr2" placeholder="Address line 2 (optional)"></div>
          <div><input name="city" placeholder="Town/City" required></div>
          <div><input name="county" placeholder="County/Region"></div>
          <div><input name="postcode" placeholder="Postcode" required></div>
          <div><input name="country" value="United Kingdom" placeholder="Country" required></div>
          <div class="full"><textarea name="notes" rows="3" placeholder="Personalised quotes/prefered colours (optional)"></textarea></div>
        </div>
      </form>

    <!-- >>> CHECKBOX MOVED TO BOTTOM OF SCROLL AREA >>> -->
<label class="ack" for="orderAcknowledge" style="margin-top:12px;">
  <input type="checkbox" id="orderAcknowledge" />
  <small>
    I understand this is a home-run startup. Some items may be out of stock. If an item isn‚Äôt available, a substitute or refund will be offered. Minor errors are possible while I‚Äôm building this up ‚Äî I‚Äôll do my best to provide the best service. 
    I also accept the <a href="terms.html" target="_blank">T&Cs</a>.
  </small>
</label>
<!-- <<< CHECKBOX AT BOTTOM OF SCROLL AREA <<< -->


    <!-- Sticky action footer -->
    <div class="checkout-actions">
      <div class="gate" id="payGate">
        <b>Step 1:</b> Press <em>Send Order by Email</em> below to confirm your details.<br/>The PayPal button will appear afterwards.
      </div>

      <button class="btn btn-accent btn-block" id="emailOrderBtn" disabled>Send Order by Email</button>

      <!-- Webmail fallback -->
      <div id="emailFallback" class="gate" style="display:none">
        Email didn‚Äôt open? Choose one:
        <div class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap">
          <a id="gmailLink"    class="btn btn-accent" target="_blank" rel="noopener">Gmail</a>
          <a id="outlookLink"  class="btn btn-accent" target="_blank" rel="noopener">Outlook.com</a>
          <a id="yahooLink"    class="btn btn-accent" target="_blank" rel="noopener">Yahoo Mail</a>
          <button id="copyOrderBtn" class="btn">Copy order text</button>
        </div>
        <div class="muted" style="margin-top:6px">The order text is copied ‚Äî just paste it in your email.</div>
      </div>

      <!-- PayPal Smart Buttons render target -->
      <div id="paypalButtons" style="display:none; padding-top:8px;"></div>
    </div>
  </div>
</div>

<!-- Discount popup -->
<div id="discountPopup" aria-modal="true" role="dialog">
  <div class="box" role="document">
    <h2>üí™ Thanks for Visiting!</h2>
    <p>Use code <b>HIT10</b> for 10% off your first order.</p>
    <p><em>‚ÄúHit your goals with HealthAndHIT‚Äù</em></p>
    <button id="discountCloseBtn" type="button">Close</button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast" role="status" aria-live="polite">Copied order to clipboard</div>

<!-- PayPal JS SDK (LIVE) -->
<script src="https://www.paypal.com/sdk/js?client-id=AQInbYyMMgyLAFSKTM_wB35q_8uROVBe9K_KzNyJEKeMMaQgtJ_DFEyY519B6n1HhB0Jzl0gNiq_AH5C&currency=GBP&intent=capture&enable-funding=card"></script>

<script>
/* -------- Settings -------- */
const MERCHANT_EMAIL = "healthandhit@gmail.com";
const SHIPPING_FLAT=3.99, FREE_SHIPPING_OVER=60;
const OPEN_DRAWER_ON_ADD = false;

/* Discount codes */
const DISCOUNT_CODES = {
  'HIT5':   {type:'percent', value:5},
  'HIT10':  {type:'percent', value:10},
  'HIT20':  {type:'percent', value:20},
  'HITFREE':{type:'free_shipping', value:0}
};
let appliedDiscount = null;

/* Delivery method state (default FREE local pickup/delivery) */
let selectedDeliveryMethod = 'local';
const DELIVERY_LABELS = {
  local: 'Local pickup/delivery ‚Äî FREE',
  post:  'Standard post ‚Äî ¬£' + SHIPPING_FLAT.toFixed(2)
};

/* -------- Inspirational quotes (PNG list) -------- */
const DEFAULT_QUOTE_LIST = [
  "Strength grows in the moments you think you can‚Äôt go on but you do",
  "The only bad workout is the one you didn‚Äôt do",
  "She believed she could so she did",
  "Strong women lift each other up",
  "Progress not perfection",
  "You are stronger than you think",
  "Sweat now shine later",
  "Don‚Äôt wish for it work for it",
  "Be the woman who decided to go for it",
  "Your only limit is you",
  "The body achieves what the mind believes",
  "Success is what comes after you stop making excuses",
  "Push yourself because no one else is going to do it for you",
  "What seems impossible today will one day become your warm up",
  "Strong is the new beautiful",
  "Every workout is progress",
  "Dream. Believe. Achieve.",
  "Don‚Äôt stop until you‚Äôre proud",
  "Pain is temporary, pride is forever",
  "Fall in love with taking care of yourself",
  "A little progress each day adds up to big results",
  "Excuses don‚Äôt burn calories",
  "Progress is progress, no matter how small",
  "Strong women empower women",
  "Wake up with determination, go to bed with satisfaction",
  "Your speed doesn‚Äôt matter, forward is forward",
  "Discipline is choosing between what you want now and what you want most",
  "You don‚Äôt get what you wish for, you get what you work for",
  "The difference between try and triumph is a little umph",
  "It‚Äôs not about being the best. It‚Äôs about being better than you were yesterday",
  "You are your only competition",
  "Stronger every day",
  "Rise and grind",
  "Don‚Äôt count the days, make the days count",
  "Progress over perfection",
  "The best project you‚Äôll ever work on is you",
  "Make yourself a priority",
  "Sweat is magic. Cover yourself in it daily",
  "Strength doesn‚Äôt come from what you can do, it comes from overcoming the things you once thought you couldn‚Äôt",
  "Work hard in silence, let success make the noise",
  "Doubt kills more dreams than failure ever will",
  "If it doesn‚Äôt challenge you, it won‚Äôt change you",
  "She remembered who she was and the game changed",
  "Stronger than yesterday",
  "Champions train, losers complain",
  "Believe you can and you‚Äôre halfway there",
  "When you feel like quitting, think about why you started",
  "The only way to finish is to start",
  "Train like a beast, look like a beauty",
  "No one ever drowned in sweat",
  "Dedication, determination, domination",
  "One workout at a time, one day at a time",
  "Muscles are earned, not given",
  "Don‚Äôt let anyone dull your sparkle",
  "Sore today, strong tomorrow",
  "Willpower knows no obstacles",
  "Be fearless in pursuit of what sets your soul on fire",
  "Confidence is silent, insecurities are loud",
  "Hustle for that muscle",
  "I‚Äôm not strong for a girl, I‚Äôm just strong",
  "Strong mind. Strong body. Strong woman.",
  "Turn the pain into power",
  "You don‚Äôt have to be extreme, just consistent"
];

/* Products */
const PRODUCTS=[
  {id:'tee',      name:'HIT T-Shirt',         price:12.00, sizes:['S','M','L','XL','2XL'], img:'tshirt.jpg'},
  {id:'vest',     name:'HIT Vest',            price:18.00, sizes:['S','M','L','XL'],       img:'vest.png'},
  {id:'jumper',   name:'HIT Jumper',          price:35.00, sizes:['S','M','L','XL'],       img:'jumper.png'},
  {id:'hoodie',   name:'HIT Hoodie',          price:38.00, sizes:['S','M','L','XL'],       img:'hoodie.png'},
  {id:'cap',      name:'HIT Cap',             price:15.00,                                   img:'cap.png'},
  {id:'subcap',   name:'Sublimated Cap',      price:12.00,                                   img:'subcap.png'},
  {id:'mug',      name:'HIT Mug',             price:12.00,                                   img:'mug.png'},
  {id:'bottle',   name:'HIT Bottle',          price:10.00,                                   img:'bottle.png'},
  {id:'keyring',  name:'HIT Keyring',         price:5.00,                                    img:'keyring.png'},
  {id:'gymbag',   name:'HIT Gym Bag',         price:12.00,                                   img:'gymbag.png'},
  {id:'towel',    name:'HIT Quick Dry Towel', price:10.00,                                   img:'towel.jpg'},
  {id:'mystery',  name:'Mystery Bundle',      price:20.00,                                   img:'mystery.png'},
  {id:'w_tshirt', name:"Women's T-Shirt",     price:12.00, sizes:['S','M','L','XL','2XL'],  img:'woman_tshirt.png', personalize:true},
  {id:'w_vest',   name:"Women's Vest",        price:12.00, sizes:['S','M','L','XL'],        img:'woman_vest.png',   personalize:true}
];

/* Helpers */
const currency=v=>'¬£'+(Math.round(v*100)/100).toFixed(2);
const grid=document.getElementById('productsGrid');
let cart=JSON.parse(localStorage.getItem('hh_cart')||'[]');

/* ------------ INVENTORY (JSON file) ------------ */
let INVENTORY = {};
async function loadInventory(){
  try{
    const res = await fetch('inventory.json', {cache:'no-store'});
    if(!res.ok) throw new Error('missing');
    const data = await res.json();
    INVENTORY = data || {};
  }catch(e){
    console.warn('inventory.json not found, treating as unlimited stock', e);
    INVENTORY = {};
  }
}
const qtyFor = (pid, size) => {
  const rec = INVENTORY[pid];
  if(!rec) return Infinity;
  if(size) return (rec[size] ?? 0);
  if('ONESIZE' in rec) return rec['ONESIZE'];
  return 0;
};
const productSoldOut = (pid, sizes) => {
  if(!sizes || sizes.length===0) return qtyFor(pid,'') <= 0;
  return sizes.every(sz => qtyFor(pid, sz) <= 0);
};
function buildSizeControl(p){
  if(!p.sizes || p.sizes.length===0){
    const left = qtyFor(p.id,'');
    const badge = (left===Infinity) ? '' : <span class="muted">Stock: ${left}</span>;
    return <input type="hidden" class="size"><span>${badge}</span>;
  }
  const opts = p.sizes.map(sz=>{
    const left = qtyFor(p.id, sz);
    const label = ${sz} ${left===Infinity?'':'(' + left + ')'};
    const disabled = (left<=0) ? 'disabled' : '';
    return <option value="${sz}" ${disabled}>${label}${left<=0?' ‚Äî Sold out':''}</option>;
  }).join('');
  return <select class="size"><option value="">Size</option>${opts}</select>;
}

/* ----- Quote dropdown helpers ----- */
function buildQuoteSelectHTML() {
  const opts = ['<option value="">Personalised Quote (add at checkout notes)( +¬£2.50 )</option>']
    .concat(DEFAULT_QUOTE_LIST.map(q => <option value="${q.replace(/"/g,'&quot;')}">${q.length>70?q.slice(0,67)+'‚Ä¶':q}</option>))
    .join('');
  return <select class="quote-select">${opts}</select>;
}
function quoteKeyPart(q) {
  return q ? 'Q:' + encodeURIComponent(q).slice(0,140) : 'Q:-';
}
function lineKey(l){
  return l.id+'|'+(l.size||'')+'|'+(l.personalize?'P':'-')+'|'+quoteKeyPart(l.quote||'');
}

/* Toast */
let toastTimer=null;
function showToast(msg='Copied order to clipboard', onClick=null){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show'); t.onclick=null;
  if(onClick){ t.onclick=()=>{ onClick(); hideToast(); }; }
  clearTimeout(toastTimer); toastTimer=setTimeout(hideToast,2000);
}
function hideToast(){ const t=document.getElementById('toast'); t.classList.remove('show'); t.onclick=null; }

function bumpFab(){ const fab=document.getElementById('basketFab'); fab.classList.remove('bump'); void fab.offsetWidth; fab.classList.add('bump'); if(navigator.vibrate) navigator.vibrate(20); }
function saveCart(){ localStorage.setItem('hh_cart', JSON.stringify(cart)); updateFab(); }

/* Add/Remove */
let lastAddedKey=null;
function addToCart(line){
  const key=lineKey(line);
  const left = qtyFor(line.id, line.size||'');
  if(!(left===Infinity) && line.qty>left){
    alert(Only ${left} left for that selection.);
    return;
  }
  const existing=cart.find(l=> lineKey(l)===key);
  const wasEmpty = cart.length===0;
  if(existing){
    const newQty = existing.qty + line.qty;
    const cap = (left===Infinity)?newQty:Math.min(newQty, left);
    existing.qty = cap;
  } else {
    cart.push(line);
  }
  if(line.size){ localStorage.setItem('hh_size_'+line.id, line.size); }
  saveCart(); renderCart();
  showToast(Added ${line.name}${line.size?' '+line.size:''}${line.personalize?' + personalised':''} ‚Äî Undo, ()=>{ removeFromCart(key); lastAddedKey=null; showToast('Removed'); });
  lastAddedKey=key; bumpFab();
  if(OPEN_DRAWER_ON_ADD && wasEmpty) openDrawer();
}
function removeFromCart(key){
  cart=cart.filter(l=> lineKey(l)!==key);
  saveCart(); renderCart();
}

/* Totals */
function computeTotals(){
  const subtotal=cart.reduce((s,l)=>s+l.price*l.qty,0);
  let shipping = 0;
  if(subtotal>0){
    if(selectedDeliveryMethod==='local') shipping = 0;
    else shipping = (subtotal>=FREE_SHIPPING_OVER?0:SHIPPING_FLAT);
  }
  let discountValue=0;
  if(appliedDiscount){
    if(appliedDiscount.type==='percent') discountValue=subtotal*(appliedDiscount.value/100);
    else if(appliedDiscount.type==='free_shipping') shipping=0;
  }
  const grand=Math.max(0, subtotal-discountValue+shipping);
  return {subtotal,shipping,discountValue,grand};
}
function updateFab(){ const {subtotal}=computeTotals(); document.getElementById('basketCount').textContent=cart.reduce((n,l)=>n+l.qty,0); document.getElementById('basketTotal').textContent=currency(subtotal); }

/* Quantity stepper template */
function stepperHTML(initial=1){
  return 
    <div class="stepper" data-stepper>
      <button type="button" class="dec" aria-label="Decrease quantity">‚àí</button>
      <input type="number" class="qty" min="1" value="${initial}">
      <button type="button" class="inc" aria-label="Increase quantity">+</button>
    </div>;
}

/* Render products */
function renderProducts(){
  grid.innerHTML='';
  PRODUCTS.forEach(p=>{
    const soldOut = productSoldOut(p.id, p.sizes);
    const card=document.createElement('article');
    card.className='card';
    card.innerHTML=
      <div class="media">
        <img loading="lazy" width="600" height="180" src="${p.img}" alt="${p.name}" onerror="this.onerror=null;this.src='comingsoon.png';">
      </div>
      <div class="body">
        <div>
          <h3 class="title">${p.name} ${soldOut?'<span class="muted">‚Äî Sold out</span>':''}</h3>
          <div class="muted">${p.sizes?'Clothing':'Accessory'}</div>
          <div class="row"><span class="price">${currency(p.price)}</span></div>
          ${p.personalize ? <div class="row">${buildQuoteSelectHTML()}</div> : ''}
          <div class="row">
            ${buildSizeControl(p)}
            ${stepperHTML(1)}
          </div>
        </div>
        <div class="row"><button class="btn btn-accent btn-block add" ${soldOut?'disabled':''}>${soldOut?'Sold out':'Add to Basket'}</button></div>
      </div>;
    if(p.sizes){
      const sel=card.querySelector('.size');
      const saved=localStorage.getItem('hh_size_'+p.id);
      if(saved && [...sel.options].some(o=>o.value===saved && !o.disabled)) sel.value=saved;
    }
    let adding=false;
    card.querySelector('.add').onclick=()=>{
      if(adding) return; adding=true;
      const sizeEl=card.querySelector('.size');
      const size=p.sizes?(sizeEl.value||''):'';
      if(p.sizes && !size){ alert('Please choose a size'); sizeEl.classList.add('error'); adding=false; return; }
      sizeEl.classList.remove('error');
      const qty=Math.max(1, parseInt(card.querySelector('.qty').value||'1',10));
      const left = qtyFor(p.id, p.sizes?size:'');
      if(!(left===Infinity) && qty>left){ alert(Only ${left} left for that size.); adding=false; return; }

      const selectedQuote = p.personalize ? (card.querySelector('.quote-select')?.value || '') : '';
      const personalize = !!selectedQuote;
      const unitPrice = p.price + (personalize ? 2.50 : 0);

      addToCart({id:p.id,name:p.name,price:unitPrice,size,qty,personalize,quote:selectedQuote});
      setTimeout(()=>adding=false,300);
    };
    grid.appendChild(card);
  });
}

/* Render cart */
function renderCart(){
  const cartItems=document.getElementById('cartItems');
  cartItems.innerHTML=cart.length?'' : '<div class="note">Your basket is empty.</div>';
  cart.forEach(l=>{
    const key=lineKey(l);
    const row=document.createElement('div');
    row.className='cart-line';
    row.dataset.key=key;
    const left = qtyFor(l.id, l.size||'');
    const capNote = (left!==Infinity) ? <span class="muted"> (Max ${left})</span> : '';
    row.innerHTML=
      <div>
        <strong>${l.name}${l.size? ‚Äî ${l.size}:''}${l.personalize?' + Personalised':''}</strong> ${capNote}
        <div class="meta">${currency(l.price)} √ó&nbsp; ${stepperHTML(l.qty)}</div>
        ${l.quote ? <div class="meta"><em>Quote:</em> ‚Äú${l.quote.replace(/</g,'&lt;')}‚Äù</div> : ''}
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div style="min-width:90px;text-align:right;font-weight:800">${currency(l.price*l.qty)}</div>
        <button class="btn btn-bad small" title="Remove">‚úï</button>
      </div>;
    row.querySelector('.btn-bad').onclick=()=>removeFromCart(key);
    cartItems.appendChild(row);
  });

  const {subtotal,shipping,discountValue,grand}=computeTotals();
  document.getElementById('subtotal').textContent=currency(subtotal);
  document.getElementById('shipping').textContent=currency(shipping);
  document.getElementById('grand').textContent=currency(grand);

  const dr=document.getElementById('discountRow'), dv=document.getElementById('discount');
  if(discountValue>0){ dr.style.display=''; dv.textContent='-'+currency(discountValue).replace('¬£',''); } else { dr.style.display='none'; }

  updateFab();

  if (document.getElementById('paypalButtons').style.display === 'block') {
    renderPayPalButtons();
  }

  // refresh scroll hint visibility after cart render
  queueMicrotask(updateScrollHint);
}

/* Quantity stepper delegation */
document.addEventListener('click',(e)=>{
  const btn=e.target.closest('.stepper .inc, .stepper .dec'); if(!btn) return;
  const wrap=btn.closest('.stepper'); const input=wrap.querySelector('input.qty');
  let val=Math.max(1, parseInt(input.value||'1',10));
  if(btn.classList.contains('inc')) val++; else val=Math.max(1,val-1);
  const row=btn.closest('.cart-line');
  if(row){
    const key=row.dataset.key;
    const line=cart.find(l=> lineKey(l)===key);
    if(line){
      const left = qtyFor(line.id, line.size||'');
      if(!(left===Infinity)) val = Math.min(val, left);
      line.qty=val; input.value=String(val); saveCart(); renderCart();
    }
  } else {
    input.value=String(val);
  }
},{passive:false});

document.addEventListener('input',(e)=>{
  const input=e.target;
  if(!(input.matches && input.matches('.cart-line input.qty'))) return;
  const row=input.closest('.cart-line'); const key=row?.dataset?.key;
  const line=cart.find(l=> lineKey(l)===key);
  let val=Math.max(1, parseInt(input.value||'1',10));
  if(line){
    const left = qtyFor(line.id, line.size||'');
    if(!(left===Infinity)) val = Math.min(val, left);
    line.qty=val; input.value=String(val); saveCart(); renderCart();
  }
});

/* >>> SCROLL LOCK PATCH >>> */
let __scrollY = 0;
function lockBodyScroll(){
  __scrollY = window.scrollY || document.documentElement.scrollTop || 0;
  document.body.style.setProperty('--scroll-lock-top', -${__scrollY}px);
  document.body.classList.add('scroll-lock');
}
function unlockBodyScroll(){
  document.body.classList.remove('scroll-lock');
  document.body.style.removeProperty('--scroll-lock-top');
  window.scrollTo(0, __scrollY || 0);
}
/* <<< SCROLL LOCK PATCH <<< */

/* >>> SCROLL HINT PATCH (JS) >>> */
const drawerContent = document.getElementById('drawerContent');
const scrollHint = document.getElementById('scrollHint');

function updateScrollHint(){
  // show only if there's overflow and we're at the very top
  const hasOverflow = drawerContent.scrollHeight > drawerContent.clientHeight + 8;
  if(!hasOverflow){
    scrollHint.style.display = 'none';
    return;
  }
  scrollHint.style.display = (drawerContent.scrollTop <= 20) ? 'block' : 'none';
}
drawerContent.addEventListener('scroll', updateScrollHint);
window.addEventListener('resize', updateScrollHint);
/* <<< SCROLL HINT PATCH <<< */

/* Drawer UX */
function openDrawer(){
  const d=document.getElementById('drawer');
  d.classList.add('open'); d.setAttribute('aria-hidden','false'); d.querySelector('.panel').focus?.();
  lockBodyScroll();
  // reset scroll & hint each open
  drawerContent.scrollTop = 0;
  updateScrollHint();
}
function closeDrawer(){
  const d=document.getElementById('drawer');
  d.classList.remove('open'); d.setAttribute('aria-hidden','true'); document.getElementById('basketFab').focus?.();
  unlockBodyScroll();
}
document.getElementById('basketFab').onclick=openDrawer;
document.getElementById('closeDrawer').onclick=closeDrawer;
document.getElementById('drawerBackdrop').onclick=closeDrawer;

/* prevent scroll-through on backdrop */
const __backdrop = document.getElementById('drawerBackdrop');
['wheel','touchmove'].forEach(evt=>{
  __backdrop.addEventListener(evt, e=>{ e.preventDefault(); }, {passive:false});
});
document.querySelector('.panel').addEventListener('wheel', e=>{ e.stopPropagation(); }, {passive:true});

document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && document.getElementById('drawer').classList.contains('open')) closeDrawer(); });

/* Prevent wheel changing number inputs */
document.addEventListener('wheel',(e)=>{ const el=document.activeElement; if(el && el.type==='number'){ el.blur(); } }, {passive:true});

/* Form persistence & validation */
function getFormData(){ const fd=new FormData(document.getElementById('checkoutForm')); return Object.fromEntries(fd.entries()); }
function validateEmailAddress(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'').trim()); }
function validateForm(showErrors=true){
  const form=document.getElementById('checkoutForm'); const c=getFormData();
  const required=['firstName','lastName','email','addr1','city','postcode','country'];
  let ok=true; form.querySelectorAll('input,textarea,select').forEach(el=>el.classList.remove('error'));
  for(const k of required){ if(!String(c[k]||'').trim()){ ok=false; if(showErrors){ form.querySelector([name="${k}"])?.classList.add('error'); } } }
  if(!validateEmailAddress(c.email)){ ok=false; if(showErrors){ form.querySelector('[name="email"]')?.classList.add('error'); alert('Please enter a valid email.'); } }
  if(!cart.length){ ok=false; if(showErrors){ alert('Your cart is empty.'); } }
  const ack = document.getElementById('orderAcknowledge');
  if(!ack.checked){ ok=false; if(showErrors){ alert('Please tick the acknowledgement to continue.'); } }
  return ok;
}
document.getElementById('checkoutForm').addEventListener('input',()=>{ localStorage.setItem('hh_checkout_form', JSON.stringify(getFormData())); });
function restoreForm(){ const raw=localStorage.getItem('hh_checkout_form'); if(!raw) return;
  const data=JSON.parse(raw); const form=document.getElementById('checkoutForm');
  Object.entries(data).forEach(([k,v])=>{ const el=form.querySelector([name="${k}"]); if(el!=null) el.value=v; });
}

/* Delivery segmented control handlers */
document.getElementById('deliverySeg').addEventListener('click',(e)=>{
  const btn = e.target.closest('button[data-method]'); if(!btn) return;
  const seg = document.getElementById('deliverySeg');
  [...seg.querySelectorAll('button')].forEach(b=>b.setAttribute('aria-pressed','false'));
  btn.setAttribute('aria-pressed','true');
  selectedDeliveryMethod = btn.dataset.method === 'post' ? 'post' : 'local';
  renderCart();
});

/* Order summary builder */
function getDeliveryLabel(){ return DELIVERY_LABELS[selectedDeliveryMethod] || 'Local pickup/delivery ‚Äî FREE'; }
function buildOrderText(){
  const c=getFormData(); const {subtotal,shipping,discountValue,grand}=computeTotals();
  const lines=cart.map(l =>
    ${l.name}${l.size? (${l.size}):''}${l.personalize?' + Personalised':''} x ${l.qty} ‚Äî ${currency(l.price*l.qty)}${l.quote?\n   ‚Ä¢ Quote: "${l.quote}":''}
  ).join('\n');
  const address=${c.firstName} ${c.lastName}\n${c.addr1}\n${c.addr2||''}\n${c.city}${c.county?, ${c.county}:''}\n${c.postcode}\n${c.country};
  const discSection=discountValue>0?Discount: -${currency(discountValue)}\n:'';
  const deliverySection=Delivery method: ${getDeliveryLabel()}\n;
  return ORDER SUMMARY ‚Äî HealthAndHIT
----------------------------
${lines}
----------------------------
Subtotal: ${currency(subtotal)}
${discSection}Shipping: ${currency(shipping)}
Total: ${currency(grand)}
${deliverySection}
CUSTOMER
Name: ${c.firstName} ${c.lastName}
Email: ${c.email}
Phone: ${c.phone||'-'}
Address:
${address}

${c.notes?Notes:\n${c.notes}\n:''}
(Please reply to confirm & arrange payment.);
}

/* Discount code */
document.getElementById('applyDiscountBtn').onclick=()=>{
  const code=(document.getElementById('discountCode').value||'').trim().toUpperCase();
  const msg=document.getElementById('discountMsg');
  if(!code){ appliedDiscount=null; msg.textContent=''; renderCart(); return; }
  if(DISCOUNT_CODES[code]){
    appliedDiscount=DISCOUNT_CODES[code];
    msg.textContent = code==='HITFREE' ? 'Free delivery applied.' : ${appliedDiscount.value}% off applied.;
  }else{ appliedDiscount=null; msg.textContent='Invalid code.'; }
  renderCart();
};

/* ----- PayPal Smart Buttons ----- */
let lastRenderedAmount = null;
function renderPayPalButtons(){
  const host = document.getElementById('paypalButtons');
  host.style.display = 'block';
  const { grand } = computeTotals();
  const amount = (Math.round(grand*100)/100).toFixed(2);
  if (amount === lastRenderedAmount && host.firstChild) return;
  host.innerHTML = "";
  lastRenderedAmount = amount;

  paypal.Buttons({
    style: { layout:'horizontal', shape:'pill', label:'pay' },
    createOrder: (data, actions) => {
      const { grand } = computeTotals();
      const value = (Math.round(grand*100)/100).toFixed(2);
      return actions.order.create({
        purchase_units: [{
          amount: { currency_code: 'GBP', value },
          description: 'HealthAndHIT order'
        }]
      });
    },
    onApprove: (data, actions) => actions.order.capture().then(details => {
      confettiBurst();
      showToast(Thanks ${details?.payer?.name?.given_name || ''}! Payment received.);
      cart=[]; saveCart(); renderCart();
      alert('Payment complete. We‚Äôll confirm your order by email shortly.');
    }),
    onError: (err) => { console.error(err); alert('PayPal error ‚Äî please try again.'); }
  }).render('#paypalButtons');
}

/* ---- PayPal.me auto-open helper ---- */
function buildPayPalMeUrl(){
  const { grand } = computeTotals();
  const amount = (Math.round(grand*100)/100).toFixed(2);
  return https://www.paypal.me/healthandhit/${amount};
}

/* Email flow */
const emailBtn=document.getElementById('emailOrderBtn');
const ackBox=document.getElementById('orderAcknowledge');
ackBox.addEventListener('change', ()=>{ emailBtn.disabled = !ackBox.checked; });

emailBtn.onclick=async ()=>{
  if(!validateForm(true)) return;

  const c=getFormData();
  const text=buildOrderText();

  try { await navigator.clipboard.writeText(text); showToast('Order copied to clipboard'); } catch(e){}

  const subject=New Order ‚Äî ${c.firstName} ${c.lastName};
  const links=buildEmailLinks({subject, body:text, to:MERCHANT_EMAIL});

  window.location.href=links.mailto;

  document.getElementById('gmailLink').href=links.gmail;
  document.getElementById('outlookLink').href=links.outlook;
  document.getElementById('yahooLink').href=links.yahoo;
  document.getElementById('copyOrderBtn').onclick=async ()=>{ try{ await navigator.clipboard.writeText(text); showToast('Order copied'); }catch(e){} };

  const gate = document.getElementById('payGate');
  gate.innerHTML = '‚úîÔ∏è Email step ready. <b>Step 2:</b> PayPal should have opened in a new tab. If not, use the PayPal button below.';

  emailBtn.style.display='none';
  renderPayPalButtons();

  try { window.open(buildPayPalMeUrl(), '_blank', 'noopener'); } catch(e){ console.warn('Could not open PayPal.me', e); }

  confettiBurst();
};

/* Confetti */
function confettiBurst(){
  const canvas=document.getElementById('confetti'), ctx=canvas.getContext('2d');
  const w=canvas.width=window.innerWidth, h=canvas.height=window.innerHeight;
  const N=140, parts=[]; for(let i=0;i<N;i++) parts.push({x:Math.random()*w,y:-20-Math.random()*h*0.3,r:2+Math.random()*4,vy:2+Math.random()*3,vx:(Math.random()-0.5)*2,a:Math.random()*Math.PI,va:(Math.random()*0.2-0.1)});
  let t=0; (function step(){ ctx.clearRect(0,0,w,h); parts.forEach(p=>{
    p.y+=p.vy; p.x+=p.vx; p.a+=p.va; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
    ctx.fillStyle=hsl(${(p.x+p.y)%360},100%,60%); ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2); ctx.restore();
  }); if(++t<120) requestAnimationFrame(step); else ctx.clearRect(0,0,w,h); })();
}

/* Popup controls */
function closeDiscount(){ const el=document.getElementById('discountPopup'); el.style.display='none'; sessionStorage.setItem('welcomeShown','true'); }
async function init(){
  await loadInventory();
  renderProducts(); renderCart(); updateFab(); restoreForm();

  const __qs=new URLSearchParams(location.search);
  if(__qs.get('welcome')==='1') sessionStorage.removeItem('welcomeShown');

  const pop=document.getElementById('discountPopup');
  if(!sessionStorage.getItem('welcomeShown')) pop.style.display='flex'; else pop.style.display='none';
  pop.addEventListener('click',(e)=>{ if(e.target.id==='discountPopup') closeDiscount(); });
  document.getElementById('discountCloseBtn').addEventListener('click', closeDiscount);
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && pop.style.display!=='none') closeDiscount(); });

  // initial state for scroll hint
  updateScrollHint();
}
init();

/* --------- Email link builders --------- */
function buildEmailLinks({to, subject, body}){
  const enc = s => encodeURIComponent(s);
  const mailto = mailto:${encodeURIComponent(to)}?subject=${enc(subject)}&body=${enc(body)};
  const gmail  = https://mail.google.com/mail/?view=cm&fs=1&to=${enc(to)}&su=${enc(subject)}&body=${enc(body)};
  const outlook= https://outlook.live.com/mail/0/deeplink/compose?to=${enc(to)}&subject=${enc(subject)}&body=${enc(body)};
  const yahoo  = https://compose.mail.yahoo.com/?to=${enc(to)}&subject=${enc(subject)}&body=${enc(body)};
  return { mailto, gmail, outlook, yahoo };
}
</script>
</body>
</html>