<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HealthAndHIT — Shop (Inventory Enabled)</title>
<meta name="color-scheme" content="dark light">

<style>
:root { --bg:#191a1e; --panel:#23242b; --card:#26272f; --accent:#ff3939; --accent-2:#ff6b6b;
  --text:#ffffff; --muted:#c9c9cf; --ok:#48c774; --warn:#ffb020; --bad:#ff4d4d;
  --radius:16px; --shadow:0 8px 30px rgba(0,0,0,.35); }
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}

/* >>> SCROLL LOCK PATCH >>> */
html { overscroll-behavior: none; }
body.scroll-lock{ position: fixed; width: 100%; overflow: hidden; top: var(--scroll-lock-top, 0px); }
/* <<< SCROLL LOCK PATCH <<< */

/* Header */
header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#1d1e23 0%,#1a1b20 100%);border-bottom:1px solid #2f3038}
.wrap{max-width:1160px;margin:0 auto;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:42px;height:42px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#ff6b6b,#ff3939 60%,#b70000);box-shadow:0 0 0 3px #2a2b31}
.brand h1{font-size:1.25rem;margin:0;font-weight:700;letter-spacing:.3px}

/* Basket FAB */
.basket-fab{position:fixed; right:18px; top:18px; display:flex; align-items:center; gap:10px;
  background:var(--accent); color:#fff; padding:10px 14px; border-radius:999px; box-shadow:var(--shadow);
  cursor:pointer; z-index:60; border:0; font-weight:700;}
.basket-fab .count{background:#000; padding:2px 8px; border-radius:999px; font-size:.85rem}

/* Hero notice */
.hero{padding:18px 16px 8px}
.hero .notice{background:#1f2027;border:1px solid #2c2d36;border-radius:var(--radius);padding:12px 14px;color:var(--muted)}

/* Product grid */
.grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:18px;margin:16px;align-items:stretch}
.grid .full{grid-column:1 / -1}
@media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:980px){.grid{grid-template-columns:repeat(3,1fr)}}

.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
  overflow:hidden;border:1px solid #2c2d36;display:grid;grid-template-rows:auto 1fr;height:100%}
.media{height:180px; background:#101015; display:flex; align-items:center; justify-content:center;}
.media img{width:100%;height:100%;object-fit:contain}
.card .body{padding:14px 14px 12px;display:flex;flex-direction:column;gap:10px}
.title{font-weight:700;margin:0 0 4px}
.price{color:#ffb923;font-weight:700}
.muted{color:var(--muted);font-size:.9rem}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select, input[type="number"], input[type="text"], input[type="email"], textarea{
  width:100%; padding:10px 12px; border-radius:10px; border:1px solid #343542; background:#1f2027; color:#fff;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-accent{background:var(--accent);color:#fff}
.btn-bad{background:var(--bad);color:#fff}
.btn-block{width:100%}
.small{font-size:.92rem}

/* Quantity stepper */
.stepper{display:inline-flex;align-items:stretch;border:1px solid #2f3040;border-radius:10px;overflow:hidden;background:#171820}
.stepper button{min-width:34px;border:0;background:#20222a;color:#fff;cursor:pointer;font-weight:800;line-height:1;
  display:flex;align-items:center;justify-content:center; user-select:none;}
.stepper input{width:64px;border:0;background:transparent;color:#fff;text-align:center;padding:8px 6px;appearance:textfield;}
.stepper input::-webkit-outer-spin-button,.stepper input::-webkit-inner-spin-button{appearance:none;margin:0}

/* Drawer */
.drawer{position:fixed; inset:0; display:none; z-index:70}
.drawer.open{display:block}
.backdrop{position:absolute; inset:0; background:rgba(0,0,0,.45)}
.panel{position:absolute; right:0; top:0; bottom:0; width:min(520px,100%); background:#1b1c22; border-left:1px solid #2b2c33;
  display:flex; flex-direction:column; height:100svh; max-height:100svh; overscroll-behavior: contain; }
.drawer-content{flex:1; min-height:0; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:0 16px 16px;}
.panel header .wrap{padding:14px 16px}
.section-title{padding:12px 0 0 0; font-weight:700}

/* >>> SCROLL HINT PATCH (CSS) >>> */
.scroll-hint{ position:sticky; top:0; text-align:center; font-size:1.35rem; line-height:1; color:var(--muted);
  opacity:.7; animation:bounceArrow 1.2s infinite; user-select:none; padding-top:6px;
  background:linear-gradient(180deg, #1b1c22 0%, rgba(27,28,34,0) 90%);}
@keyframes bounceArrow{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}
/* <<< SCROLL HINT PATCH <<< */

/* Lines */
.cart-items{display:flex;flex-direction:column;gap:12px; padding-top:10px}
.cart-line{display:grid;grid-template-columns:1fr auto;gap:10px;border:1px solid #2b2c36;border-radius:12px;padding:12px;background:#20222a}
.cart-line .meta{font-size:.9rem;color:var(--muted)}

/* Totals */
.totals{border-top:1px dashed #353644;margin-top:12px;padding-top:10px;color:#ddd}
.totals .row2{display:flex;justify-content:space-between;margin:6px 0}
.totals .grand{font-size:1.15rem;font-weight:800;color:#fff}

/* Delivery method segmented control */
.seg{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.seg button{flex:1;border:1px solid #3a3b47;background:#1f2027;color:#fff;border-radius:10px;padding:10px;font-weight:700;cursor:pointer}
.seg button[aria-pressed="true"]{outline:2px solid var(--ok); border-color:#2a3;}

/* Discount row */
.discount-row{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
.discount-row input{flex:1}

/* Sticky action bar */
.checkout-actions{position:sticky; bottom:0; inset-inline:0; background:#181920; border-top:1px solid #2b2c33;
  padding:12px 16px; display:flex; flex-direction:column; gap:10px;}
.gate{border:1px dashed #3a3b47; padding:10px; border-radius:10px; color:#cfcfe5; font-size:.95rem;}

/* Acknowledgement */
.ack{display:flex;gap:10px; align-items:flex-start; background:#1f2027; border:1px solid #2c2d36; padding:10px; border-radius:10px;}
.ack input{margin-top:3px}
.ack small{color:#cfcfe5; line-height:1.35}

/* >>> T&Cs SHAKE + HIGHLIGHT >>> */
.ack.highlight { border-color: var(--bad); box-shadow: 0 0 6px var(--bad); animation: shake 0.4s ease; }
@keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-6px); } 40%, 80% { transform: translateX(6px); } }

/* Popup + toast */
#discountPopup{position: fixed; inset:0; background: rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:999;}
#discountPopup .box{background: var(--card); padding: 20px; border-radius: var(--radius); max-width: 320px; text-align:center; box-shadow: var(--shadow);}
#discountCloseBtn{margin-top:10px; padding:8px 14px; border:0; background:var(--accent); color:#fff; border-radius:8px; cursor:pointer;}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%); background:#000b;border:1px solid #333;padding:10px 14px;border-radius:10px;z-index:120;color:#fff;display:none;cursor:pointer}
.toast.show{display:block}

/* Confetti canvas */
#confetti{position:fixed;inset:0;pointer-events:none;z-index:200}

/* FAB bump */
.basket-fab.bump{animation:bump 300ms ease}
@keyframes bump{0%{transform:scale(1)}10%{transform:scale(1.06)}30%{transform:scale(1.12)}100%{transform:scale(1)}}

/* >>> NEW: Colour swatches */
.swatches{display:flex; gap:10px; flex-wrap:wrap; margin-top:2px}
.swatch{width:28px; height:28px; border-radius:999px; border:2px solid #2e2f3a; position:relative; cursor:pointer; box-shadow:inset 0 0 0 2px rgba(0,0,0,.25)}
.swatch .check{display:none; position:absolute; inset:0; align-items:center; justify-content:center; font-size:14px; color:#fff; text-shadow:0 1px 2px #000}
.swatch.active .check{display:flex}
.swatch.disabled{ filter:grayscale(1) brightness(.65); cursor:not-allowed; }
.swatch.disabled::after{ content:"✕"; position:absolute; inset:0; display:grid; place-items:center; font-weight:900; color:#fff; text-shadow:0 1px 2px #000; }
.color-chip{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid #444; background:#16171d; margin-top:6px; font-size:.85rem}
.color-dot{width:12px; height:12px; border-radius:999px; border:1px solid #333; box-shadow:inset 0 0 0 1px rgba(0,0,0,.25)}
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<header>
  <div class="wrap brand">
    <div class="logo"></div>
    <h1>HealthAndHIT — Shop</h1>
  </div>
</header>

<button class="basket-fab" id="basketFab">🧺 <span class="count" id="basketCount">0</span> <span class="count" id="basketTotal">£0.00</span></button>

<section class="hero wrap">
  <div class="notice">🔴 <b>Now Open</b> — Per-size stock is live. Add items, then tap the basket to checkout.</div>
</section>

<section class="grid" id="productsGrid"></section>

<!-- Drawer -->
<div class="drawer" id="drawer" aria-hidden="true">
  <div class="backdrop" id="drawerBackdrop" tabindex="-1"></div>
  <div class="panel" role="dialog" aria-label="Basket drawer" tabindex="-1">
    <header>
      <div class="wrap" style="display:flex;justify-content:space-between;align-items:center">
        <strong>🧺 Your Basket</strong>
        <button class="btn btn-bad small" id="closeDrawer" aria-label="Close basket">Close</button>
      </div>
    </header>

    <div class="drawer-content" id="drawerContent">
      <div id="scrollHint" class="scroll-hint" aria-hidden="true">⌄</div>

      <div class="section-title">Items</div>
      <div class="cart-items" id="cartItems"></div>

      <div class="totals">
        <div class="row2"><span>Subtotal</span><strong id="subtotal">£0.00</strong></div>
        <div class="row2"><span>Shipping</span><span id="shipping">£0.00</span></div>
        <div class="row2" id="discountRow" style="display:none;"><span>Discount</span><span id="discount">-£0.00</span></div>
        <div class="row2 grand"><span>Total</span><span id="grand">£0.00</span></div>

        <div class="section-title">Delivery method</div>
        <div class="seg" id="deliverySeg">
          <button type="button" data-method="local" aria-pressed="true">Local pickup / delivery — FREE</button>
          <button type="button" data-method="post" aria-pressed="false">Standard post — £3.99</button>
        </div>

        <div class="discount-row" style="margin-top:12px">
          <input id="discountCode" placeholder="Discount code"/>
          <button class="btn btn-accent" id="applyDiscountBtn" type="button">Apply</button>
        </div>
        <div class="muted" id="discountMsg" style="margin-top:4px;"></div>
      </div>

      <div class="section-title">Delivery details</div>
      <form class="form" id="checkoutForm" novalidate>
        <div class="grid">
          <div><input name="firstName" placeholder="First name" required></div>
          <div><input name="lastName" placeholder="Last name" required></div>
          <div class="full"><input name="email" type="email" placeholder="Email" required></div>
          <div class="full"><input name="phone" placeholder="Phone"></div>
          <div class="full"><input name="addr1" placeholder="Address line 1" required></div>
          <div class="full"><input name="addr2" placeholder="Address line 2 (optional)"></div>
          <div><input name="city" placeholder="Town/City" required></div>
          <div><input name="county" placeholder="County/Region"></div>
          <div><input name="postcode" placeholder="Postcode" required></div>
          <div><input name="country" value="United Kingdom" placeholder="Country" required></div>
          <div class="full"><textarea name="notes" rows="3" placeholder="Personalised quotes/prefered colours (optional)"></textarea></div>
        </div>
      </form>

      <label class="ack" for="orderAcknowledge" style="margin-top:12px;">
        <input type="checkbox" id="orderAcknowledge" />
        <small>
          I understand this is a home-run startup. Some items may be out of stock. If an item isn’t available, a substitute or refund will be offered. Minor errors are possible while I’m building this up — I’ll do my best to provide the best service.
          I also accept the <a href="terms.html" target="_blank">T&Cs</a>.
        </small>
      </label>

      <div class="checkout-actions">
        <div class="gate" id="payGate">
          <b>Step 1:</b> Press <em>Send Order by Email</em> to submit details. <b>Step 2:</b> Pay using the PayPal button that appears below.
        </div>

        <button class="btn btn-accent btn-block" id="emailOrderBtn">Send Order by Email</button>

        <div id="emailFallback" class="gate" style="display:none">
          Email didn’t open? Choose one:
          <div class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap">
            <a id="gmailLink"    class="btn btn-accent" target="_blank" rel="noopener">Gmail</a>
            <a id="outlookLink"  class="btn btn-accent" target="_blank" rel="noopener">Outlook.com</a>
            <a id="yahooLink"    class="btn btn-accent" target="_blank" rel="noopener">Yahoo Mail</a>
            <button id="copyOrderBtn" class="btn">Copy order text</button>
          </div>
          <div class="muted" style="margin-top:6px">The order text is copied — just paste it in your email.</div>
        </div>

        <div id="paypalButtons" style="display:none; padding-top:8px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Discount popup -->
<div id="discountPopup" aria-modal="true" role="dialog">
  <div class="box" role="document">
    <h2>💪 Thanks for Visiting!</h2>
    <p>Use code <b>HIT10</b> for 10% off your first order.</p>
    <p><em>“Hit your goals with HealthAndHIT”</em></p>
    <button id="discountCloseBtn" type="button">Close</button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast" role="status" aria-live="polite">Copied order to clipboard</div>

<!-- PayPal JS SDK (LIVE) -->
<script src="https://www.paypal.com/sdk/js?client-id=AQInbYyMMgyLAFSKTM_wB35q_8uROVBe9K_KzNyJEKeMMaQgtJ_DFEyY519B6n1HhB0Jzl0gNiq_AH5C&currency=GBP&intent=capture&enable-funding=card"></script>

<script>
/* -------- Settings -------- */
const MERCHANT_EMAIL = "healthandhit@gmail.com";
const SHIPPING_FLAT=3.99, FREE_SHIPPING_OVER=60;
const OPEN_DRAWER_ON_ADD = false;

/* Discount codes */
const DISCOUNT_CODES = { 'HIT5':{type:'percent',value:5}, 'HIT10':{type:'percent',value:10},
  'HIT20':{type:'percent',value:20}, 'HITFREE':{type:'free_shipping',value:0} };
let appliedDiscount = null;

/* Delivery method state */
let selectedDeliveryMethod = 'local';
const DELIVERY_LABELS = {
  local: 'Local pickup/delivery — FREE',
  post:  'Standard post — £' + SHIPPING_FLAT.toFixed(2)
};

/* Quotes */
const DEFAULT_QUOTE_LIST = [
  "Strength grows in the moments you think you can’t go on but you do",
  "The only bad workout is the one you didn’t do",
  "She believed she could so she did",
  "Strong women lift each other up",
  "Progress not perfection",
  "You are stronger than you think",
  "Sweat now shine later",
  "Don’t wish for it work for it",
  "Be the woman who decided to go for it",
  "Your only limit is you",
  "The body achieves what the mind believes",
  "Success is what comes after you stop making excuses",
  "Push yourself because no one else is going to do it for you",
  "What seems impossible today will one day become your warm up",
  "Strong is the new beautiful",
  "Every workout is progress",
  "Dream. Believe. Achieve.",
  "Don’t stop until you’re proud",
  "Pain is temporary, pride is forever",
  "Fall in love with taking care of yourself",
  "A little progress each day adds up to big results",
  "Excuses don’t burn calories",
  "Progress is progress, no matter how small",
  "Strong women empower women",
  "Wake up with determination, go to bed with satisfaction",
  "Your speed doesn’t matter, forward is forward",
  "Discipline is choosing between what you want now and what you want most",
  "You don’t get what you wish for, you get what you work for",
  "The difference between try and triumph is a little umph",
  "It’s not about being the best. It’s about being better than you were yesterday",
  "You are your only competition",
  "Stronger every day",
  "Rise and grind",
  "Don’t count the days, make the days count",
  "Progress over perfection",
  "The best project you’ll ever work on is you",
  "Make yourself a priority",
  "Sweat is magic. Cover yourself in it daily",
  "Strength doesn’t come from what you can do, it comes from overcoming the things you once thought you couldn’t",
  "Work hard in silence, let success make the noise",
  "Doubt kills more dreams than failure ever will",
  "If it doesn’t challenge you, it won’t change you",
  "She remembered who she was and the game changed",
  "Stronger than yesterday",
  "Champions train, losers complain",
  "Believe you can and you’re halfway there",
  "When you feel like quitting, think about why you started",
  "The only way to finish is to start",
  "Train like a beast, look like a beauty",
  "No one ever drowned in sweat",
  "Dedication, determination, domination",
  "One workout at a time, one day at a time",
  "Muscles are earned, not given",
  "Don’t let anyone dull your sparkle",
  "Sore today, strong tomorrow",
  "Willpower knows no obstacles",
  "Be fearless in pursuit of what sets your soul on fire",
  "Confidence is silent, insecurities are loud",
  "Hustle for that muscle",
  "I’m not strong for a girl, I’m just strong",
  "Strong mind. Strong body. Strong woman.",
  "Turn the pain into power",
  "You don’t have to be extreme, just consistent"
];

/* Products */
const PRODUCTS=[
  {id:'tee',      name:'HIT T-Shirt',         price:12.00, sizes:['S','M','L','XL','2XL'], img:'tshirt.jpg'},
  {id:'vest',     name:'HIT Vest',            price:18.00, sizes:['S','M','L','XL'],       img:'vest.png'},
  {id:'jumper',   name:'HIT Jumper',          price:35.00, sizes:['S','M','L','XL'],       img:'jumper.png'},
  {id:'hoodie',   name:'HIT Hoodie',          price:38.00, sizes:['S','M','L','XL'],       img:'hoodie.png'},
  {id:'cap',      name:'HIT Cap',             price:15.00,                                   img:'cap.png'},
  {id:'subcap',   name:'Sublimated Cap',      price:12.00,                                   img:'subcap.png'},
  {id:'mug',      name:'HIT Mug',             price:12.00,                                   img:'mug.png'},
  {id:'bottle',   name:'HIT Bottle',          price:10.00,                                   img:'bottle.png'},
  {id:'keyring',  name:'HIT Keyring',         price:5.00,                                    img:'keyring.png'},
  {id:'gymbag',   name:'HIT Gym Bag',         price:12.00,                                   img:'gymbag.png'},
  {id:'towel',    name:'HIT Quick Dry Towel', price:10.00,                                   img:'towel.jpg'},
  {id:'mystery',  name:'Mystery Bundle',      price:20.00,                                   img:'mystery.png'},
  {id:'w_tshirt', name:"Women's T-Shirt",     price:12.00, sizes:['S','M','L','XL','2XL'],  img:'woman_tshirt.png', personalize:true},
  {id:'w_vest',   name:"Women's Vest",        price:12.00, sizes:['S','M','L','XL'],        img:'woman_vest.png',   personalize:true}
];

/* Helpers */
const currency=v=>'£'+(Math.round(v*100)/100).toFixed(2);
const grid=document.getElementById('productsGrid');
let cart=JSON.parse(localStorage.getItem('hh_cart')||'[]');

/* Inventory */
let INVENTORY = {};
function safeLoadInventory(){
  fetch('inventory.json', {cache:'no-store'})
    .then(r=>r.ok?r.json():null)
    .then(j=>{ if(j){ INVENTORY=j; recheckAllColourSwatches(); refreshAllSizeOptions(); refreshAllOneSizeBadges(); } })
    .catch(()=>{});
}

/* ---------- COLOUR + SIZE AWARE QUANTITIES ---------- */
function firstColourKey(pid){
  const rec = INVENTORY[pid];
  if (!rec || !rec.COLORS) return null;
  const keys = Object.keys(rec.COLORS);
  return keys.length ? keys[0] : null;
}
function qtyFor(pid, size, colorKey){
  const rec = INVENTORY[pid];
  if (!rec || !rec.COLORS) return Infinity; // treat as unlimited if no colour structure provided
  const key = colorKey || firstColourKey(pid);
  if (!key) return 0;
  const bucket = rec.COLORS[key];
  if (!bucket) return 0;
  if (size) return bucket[size] ?? 0;
  return bucket['ONESIZE'] ?? 0;
}
function productSoldOut(pid, sizes){
  const rec = INVENTORY[pid];
  if (!rec || !rec.COLORS) return false; // unknown → assume available
  const colours = Object.keys(rec.COLORS);
  if (!sizes || sizes.length === 0) {
    // one-size: if ALL colours have ONESIZE 0 or missing → sold out
    return colours.every(c => (rec.COLORS[c].ONESIZE ?? 0) <= 0);
  }
  // clothing: sold out only if every colour has 0 for every size
  return colours.every(c => sizes.every(sz => (rec.COLORS[c][sz] ?? 0) <= 0));
}

/* >>> Colour UI helpers */
const COLOR_OPTIONS = [
  { key:'black', name:'Black', hex:'#111111' },
  { key:'white', name:'White', hex:'#ffffff' },
  { key:'red',   name:'Red',   hex:'#ff2b2b' },
  { key:'pink',  name:'Pink',  hex:'#ff6ea8' },
  { key:'blue',  name:'Blue',  hex:'#2b6cff' }
];
function buildColorSelectorHTML(){
  const dots = COLOR_OPTIONS.map(c=>{
    const ring = c.key==='white' ? 'box-shadow:inset 0 0 0 1px rgba(0,0,0,.35);' : '';
    return `<div class="swatch" data-key="${c.key}" title="${c.name}" style="background:${c.hex};${ring}"><div class="check">✓</div></div>`;
  }).join('');
  return `<div class="row"><div class="muted">Colour:</div><div class="swatches" data-swatches>${dots}</div></div>`;
}
function getSelectedColour(wrap){
  const el = wrap?.querySelector('.swatch.active'); if(!el) return null;
  const key = el.getAttribute('data-key'); const cfg = COLOR_OPTIONS.find(x=>x.key===key);
  return cfg ? { key:cfg.key, name:cfg.name, hex:cfg.hex } : null;
}
function hasColorInventory(pid){ const rec = INVENTORY[pid]; return !!(rec && rec.COLORS); }
function qtyForColor(pid, size, colorKey){ return qtyFor(pid, size, colorKey); }

function refreshColourSwatches(cardEl, product){
  const sizeEl = cardEl.querySelector('.size');
  const size = product.sizes ? (sizeEl?.value || "") : "";
  const enforce = hasColorInventory(product.id);
  cardEl.querySelectorAll('[data-swatches] .swatch').forEach(sw=>{
    const key = sw.getAttribute('data-key');
    const left = qtyForColor(product.id, product.sizes ? size : "", key);
    if(enforce){
      if(left <= 0){ sw.classList.add('disabled'); sw.classList.remove('active'); sw.title = (size ? `${key} (${size}) — out of stock` : `${key} — out of stock`); }
      else { sw.classList.remove('disabled'); sw.title = COLOR_OPTIONS.find(c=>c.key===key)?.name || key; }
    }else{
      sw.classList.remove('disabled');
    }
  });
}

/* ----- Size options are rebuilt per selected colour ----- */
function refreshSizeOptions(cardEl, product){
  const sel = cardEl.querySelector('.size');
  if(!sel) return;
  const swatchWrap = cardEl.querySelector('[data-swatches]');
  const color = getSelectedColour(swatchWrap)?.key || firstColourKey(product.id);
  const saved = localStorage.getItem('hh_size_'+product.id) || '';
  let html = '<option value="">Size</option>';
  (product.sizes || []).forEach(sz=>{
    const left = qtyFor(product.id, sz, color);
    const disabled = left <= 0 ? 'disabled' : '';
    const label = `${sz}${Number.isFinite(left)?` (${left})`:''}`;
    html += `<option value="${sz}" ${disabled}>${label}${left<=0?' — Sold out':''}</option>`;
  });
  sel.innerHTML = html;
  if(saved && [...sel.options].some(o=>o.value===saved && !o.disabled)) sel.value=saved;
}
function refreshAllSizeOptions(){
  document.querySelectorAll('.card').forEach(card=>{
    const pid = card.getAttribute('data-pid');
    const product = PRODUCTS.find(p=>p.id===pid);
    if(product?.sizes) refreshSizeOptions(card, product);
  });
}
function refreshOneSizeBadge(cardEl, product){
  if(product.sizes && product.sizes.length) return;
  const wrap = cardEl.querySelector('[data-swatches]');
  const colorKey = getSelectedColour(wrap)?.key || firstColourKey(product.id);
  const left = qtyFor(product.id, '', colorKey);
  const badge = cardEl.querySelector('[data-onesize-badge]');
  if(badge) badge.textContent = (left===Infinity)?'' : (left>0?`Stock: ${left}`:'Sold out');
}
function refreshAllOneSizeBadges(){
  document.querySelectorAll('.card').forEach(card=>{
    const pid = card.getAttribute('data-pid');
    const product = PRODUCTS.find(p=>p.id===pid);
    if(product) refreshOneSizeBadge(card, product);
  });
}

/* Quote helpers */
function buildQuoteSelectHTML(){
  const opts = [
    '<option value="">Select a quote (optional)</option>',
    '<option value="__PERS__">Personalised (add at checkout notes) — +£2.50</option>',
    ...DEFAULT_QUOTE_LIST.map(q =>
      `<option value="${q.replace(/"/g,'&quot;')}">${q.length>70 ? q.slice(0,67)+'…' : q}</option>`
    )
  ].join('');
  return `<select class="quote-select">${opts}</select>`;
}
function quoteKeyPart(q){ return q ? 'Q:' + encodeURIComponent(q).slice(0,140) : 'Q:-'; }
function lineKey(l){
  const colorPart = l.color ? ('|C:'+l.color.key) : '|C:-';
  return l.id+'|'+(l.size||'')+'|'+(l.personalize?'P':'-')+'|'+quoteKeyPart(l.quote||'')+colorPart;
}

/* Toast */
let toastTimer=null;
function showToast(msg='Copied order to clipboard', onClick=null){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); t.onclick=null; if(onClick){ t.onclick=()=>{ onClick(); hideToast(); }; } clearTimeout(toastTimer); toastTimer=setTimeout(hideToast,2000); }
function hideToast(){ const t=document.getElementById('toast'); t.classList.remove('show'); t.onclick=null; }

function bumpFab(){ const fab=document.getElementById('basketFab'); fab.classList.remove('bump'); void fab.offsetWidth; fab.classList.add('bump'); if(navigator.vibrate) navigator.vibrate(20); }
function saveCart(){ localStorage.setItem('hh_cart', JSON.stringify(cart)); updateFab(); }

/* Add/Remove */
let lastAddedKey=null;
function addToCart(line){
  const key=lineKey(line);

  // Check stock for SIZE + COLOUR
  const leftSizeColor = qtyFor(line.id, line.size || '', line.color?.key);
  if(!(leftSizeColor===Infinity) && line.qty>leftSizeColor){ alert(`Only ${leftSizeColor} left for that colour/size.`); return; }

  const existing=cart.find(l=> lineKey(l)===key);
  const wasEmpty = cart.length===0;
  if(existing){
    const newQty = existing.qty + line.qty;
    const cap = (leftSizeColor===Infinity) ? newQty : Math.min(newQty, leftSizeColor);
    existing.qty = cap;
  } else {
    cart.push(line);
  }
  if(line.size){ localStorage.setItem('hh_size_'+line.id, line.size); }
  saveCart(); renderCart();
  showToast(`Added ${line.name}${line.size?' '+line.size:''}${line.personalize?' + personalised':''}${line.color?' • '+line.color.name:''} — Undo`, ()=>{ removeFromCart(key); lastAddedKey=null; showToast('Removed'); });
  lastAddedKey=key; bumpFab();
  if(OPEN_DRAWER_ON_ADD && wasEmpty) openDrawer();
}
function removeFromCart(key){ cart=cart.filter(l=> lineKey(l)!==key); saveCart(); renderCart(); }

/* Totals */
function computeTotals(){
  const subtotal=cart.reduce((s,l)=>s+l.price*l.qty,0);
  let shipping=0; if(subtotal>0){ shipping = (selectedDeliveryMethod==='local')?0:(subtotal>=FREE_SHIPPING_OVER?0:SHIPPING_FLAT); }
  let discountValue=0;
  if(appliedDiscount){ if(appliedDiscount.type==='percent') discountValue=subtotal*(appliedDiscount.value/100); else if(appliedDiscount.type==='free_shipping') shipping=0; }
  const grand=Math.max(0, subtotal-discountValue+shipping);
  return {subtotal,shipping,discountValue,grand};
}
function updateFab(){ const {subtotal}=computeTotals(); document.getElementById('basketCount').textContent=cart.reduce((n,l)=>n+l.qty,0); document.getElementById('basketTotal').textContent=currency(subtotal); }

/* Stepper template */
function stepperHTML(initial=1){ return `<div class="stepper" data-stepper><button type="button" class="dec" aria-label="Decrease quantity">−</button><input type="number" class="qty" min="1" value="${initial}"><button type="button" class="inc" aria-label="Increase quantity">+</button></div>`; }

/* Render products */
function renderProducts(){
  grid.innerHTML='';
  PRODUCTS.forEach(p=>{
    const soldOut = productSoldOut(p.id, p.sizes);
    const card=document.createElement('article');
    card.className='card';
    card.setAttribute('data-pid', p.id);
    card.innerHTML=`
      <div class="media">
        <img loading="lazy" width="600" height="180" src="${p.img}" alt="${p.name}" onerror="this.onerror=null;this.src='comingsoon.png';">
      </div>
      <div class="body">
        <div>
          <h3 class="title">${p.name} ${soldOut?'<span class="muted">— Sold out</span>':''}</h3>
          <div class="muted">${p.sizes?'Clothing':'Accessory'}</div>
          <div class="row"><span class="price">${currency(p.price)}</span></div>
          ${p.personalize ? `<div class="row">${buildQuoteSelectHTML()}</div>` : ''}
          ${buildColorSelectorHTML()}
          <div class="row">
            ${buildSizeControl(p)}
            ${stepperHTML(1)}
          </div>
        </div>
        <div class="row"><button class="btn btn-accent btn-block add" ${soldOut?'disabled':''}>${soldOut?'Sold out':'Add to Basket'}</button></div>
      </div>`;

    // SWATCH logic
    const swatchWrap = card.querySelector('[data-swatches]');
    if(swatchWrap){
      swatchWrap.addEventListener('click', (e)=>{
        const el = e.target.closest('.swatch'); if(!el || el.classList.contains('disabled')) return;
        const active = swatchWrap.querySelector('.swatch.active');
        if(active === el){ el.classList.remove('active'); } else { if(active) active.classList.remove('active'); el.classList.add('active'); }
        refreshColourSwatches(card, p);
        refreshSizeOptions(card, p);
        refreshOneSizeBadge(card, p);
      });
    }

    // Size change should recompute swatch enabled state
    card.querySelector('.size')?.addEventListener('change', ()=> refreshColourSwatches(card, p));

    // Add handler
    let adding=false;
    card.querySelector('.add').onclick=()=>{
      if(adding) return; adding=true;

      const sizeEl=card.querySelector('.size');
      const size=p.sizes?(sizeEl.value||''):'';
      if(p.sizes && !size){ alert('Please choose a size'); sizeEl.classList.add('error'); adding=false; return; }
      sizeEl.classList.remove('error');

      const qty=Math.max(1, parseInt(card.querySelector('.qty').value||'1',10));
      const swatchWrap = card.querySelector('[data-swatches]');
      let color = getSelectedColour(swatchWrap);

      if(hasColorInventory(p.id)){
        // if no colour picked, auto-pick first with stock for that size
        if(!color){
          const rec = INVENTORY[p.id]; const keys = Object.keys(rec.COLORS||{});
          const candidate = keys.find(k => qtyFor(p.id, p.sizes?size:'', k) > 0);
          if(candidate){
            const cfg = COLOR_OPTIONS.find(c=>c.key===candidate) || {key:candidate, name:candidate, hex:'#000'};
            color = {key:cfg.key, name:cfg.name, hex:cfg.hex};
          }
        }
        if(!color){ alert('Please choose a colour'); adding=false; return; }
        const leftColor = qtyForColor(p.id, p.sizes?size:'', color.key);
        if(leftColor <= 0){ alert('That colour is out of stock for the selected size.'); adding=false; return; }
        if(!(leftColor===Infinity) && qty>leftColor){ alert(`Only ${leftColor} left for that colour/size.`); adding=false; return; }
      }

      const selectedQuote = p.personalize ? (card.querySelector('.quote-select')?.value || '') : '';
      const personalize = !!selectedQuote; const unitPrice = p.price + (personalize ? 2.50 : 0);

      addToCart({id:p.id,name:p.name,price:unitPrice,size,qty,personalize,quote:selectedQuote,color});
      setTimeout(()=>adding=false,300);
    };

    // initial refreshes
    refreshColourSwatches(card, p);
    if(p.sizes) refreshSizeOptions(card, p); else addOneSizeBadgeNode(card, p);

    grid.appendChild(card);
  });
}

function addOneSizeBadgeNode(cardEl, product){
  const host = document.createElement('div');
  host.className = 'muted';
  host.setAttribute('data-onesize-badge','');
  const row = cardEl.querySelector('.row');
  row.insertAdjacentElement('afterend', host);
  refreshOneSizeBadge(cardEl, product);
}

/* Build sizes — placeholder; options are built per colour later */
function buildSizeControl(p){
  if(!p.sizes||p.sizes.length===0){
    return `<input type="hidden" class="size">`;
  }
  return `<select class="size"><option value="">Size</option></select>`;
}

/* Render cart */
function renderCart(){
  const cartItems=document.getElementById('cartItems');
  cartItems.innerHTML=cart.length?'' : '<div class="note">Your basket is empty.</div>';
  cart.forEach(l=>{
    const key=lineKey(l);
    const row=document.createElement('div');
    row.className='cart-line';
    row.dataset.key=key;
    const left = qtyFor(l.id, l.size||'', l.color?.key);
    const capNote = (left!==Infinity) ? `<span class="muted"> (Max ${left})</span>` : '';
    const colorBadge = l.color ? `<div class="color-chip"><span class="color-dot" style="background:${l.color.hex}"></span>${l.color.name}</div>` : '';
    row.innerHTML=`
      <div>
        <strong>${l.name}${l.size?` — ${l.size}`:''}${l.personalize?' + Personalised':''}</strong> ${capNote}
        ${colorBadge}
        <div class="meta">${currency(l.price)} ×&nbsp; ${stepperHTML(l.qty)}</div>
        ${l.quote ? `<div class="meta"><em>Quote:</em> “${l.quote.replace(/</g,'&lt;')}”</div>` : ''}
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div style="min-width:90px;text-align:right;font-weight:800">${currency(l.price*l.qty)}</div>
        <button class="btn btn-bad small" title="Remove">✕</button>
      </div>`;
    row.querySelector('.btn-bad').onclick=()=>removeFromCart(key);
    cartItems.appendChild(row);
  });

  const {subtotal,shipping,discountValue,grand}=computeTotals();
  document.getElementById('subtotal').textContent=currency(subtotal);
  document.getElementById('shipping').textContent=currency(shipping);
  document.getElementById('grand').textContent=currency(grand);

  const dr=document.getElementById('discountRow'), dv=document.getElementById('discount');
  if(discountValue>0){ dr.style.display=''; dv.textContent='-'+currency(discountValue).replace('£',''); } else { dr.style.display='none'; }

  updateFab();

  if (document.getElementById('paypalButtons').style.display === 'block') {
    renderPayPalButtons();
  }

  queueMicrotask(updateScrollHint);
}

/* Stepper delegation (now colour-aware for caps) */
document.addEventListener('click',(e)=>{
  const btn=e.target.closest('.stepper .inc, .stepper .dec'); if(!btn) return;
  const wrap=btn.closest('.stepper'); const input=wrap.querySelector('input.qty');
  let val=Math.max(1, parseInt(input.value||'1',10));
  if(btn.classList.contains('inc')) val++; else val=Math.max(1,val-1);
  const row=btn.closest('.cart-line');
  if(row){
    const key=row.dataset.key;
    const line=cart.find(l=> lineKey(l)===key);
    if(line){
      const left = qtyFor(line.id, line.size||'', line.color?.key);
      if(!(left===Infinity)) val = Math.min(val, left);
      line.qty=val; input.value=String(val); saveCart(); renderCart();
    }
  } else { input.value=String(val); }
},{passive:false});

document.addEventListener('input',(e)=>{
  const input=e.target;
  if(!(input.matches && input.matches('.cart-line input.qty'))) return;
  const row=input.closest('.cart-line'); const key=row?.dataset?.key;
  const line=cart.find(l=> lineKey(l)===key);
  let val=Math.max(1, parseInt(input.value||'1',10));
  if(line){
    const left = qtyFor(line.id, line.size||'', line.color?.key);
    if(!(left===Infinity)) val = Math.min(val, left);
    line.qty=val; input.value=String(val); saveCart(); renderCart();
  }
});

/* Scroll lock */
let __scrollY = 0;
function lockBodyScroll(){ __scrollY = window.scrollY || document.documentElement.scrollTop || 0; document.body.style.setProperty('--scroll-lock-top', `-${__scrollY}px`); document.body.classList.add('scroll-lock'); }
function unlockBodyScroll(){ document.body.classList.remove('scroll-lock'); document.body.style.removeProperty('--scroll-lock-top'); window.scrollTo(0, __scrollY || 0); }

/* Scroll hint */
const drawerContent = document.getElementById('drawerContent');
const scrollHint = document.getElementById('scrollHint');
function updateScrollHint(){ const hasOverflow = drawerContent.scrollHeight > drawerContent.clientHeight + 8;
  if(!hasOverflow){ scrollHint.style.display='none'; return; } scrollHint.style.display = (drawerContent.scrollTop <= 20) ? 'block' : 'none'; }
drawerContent.addEventListener('scroll', updateScrollHint); window.addEventListener('resize', updateScrollHint);

/* Drawer UX */
function openDrawer(){ const d=document.getElementById('drawer'); d.classList.add('open'); d.setAttribute('aria-hidden','false'); d.querySelector('.panel').focus?.(); lockBodyScroll(); drawerContent.scrollTop = 0; updateScrollHint(); }
function closeDrawer(){ const d=document.getElementById('drawer'); d.classList.remove('open'); d.setAttribute('aria-hidden','true'); document.getElementById('basketFab').focus?.(); unlockBodyScroll(); }
document.getElementById('basketFab').onclick=openDrawer;
document.getElementById('closeDrawer').onclick=closeDrawer;
document.getElementById('drawerBackdrop').onclick=closeDrawer;
const __backdrop = document.getElementById('drawerBackdrop');
['wheel','touchmove'].forEach(evt=>{ __backdrop.addEventListener(evt, e=>{ e.preventDefault(); }, {passive:false}); });
document.querySelector('.panel').addEventListener('wheel', e=>{ e.stopPropagation(); }, {passive:true});
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && document.getElementById('drawer').classList.contains('open')) closeDrawer(); });
document.addEventListener('wheel',(e)=>{ const el=document.activeElement; if(el && el.type==='number'){ el.blur(); } }, {passive:true});

/* Form persistence & validation */
function getFormData(){ const fd=new FormData(document.getElementById('checkoutForm')); return Object.fromEntries(fd.entries()); }
function validateEmailAddress(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'').trim()); }
function validateForm(showErrors=true){
  const form=document.getElementById('checkoutForm'); const c=getFormData();
  const required=['firstName','lastName','email','addr1','city','postcode','country'];
  let ok=true; form.querySelectorAll('input,textarea,select').forEach(el=>el.classList.remove('error'));
  for(const k of required){ if(!String(c[k]||'').trim()){ ok=false; if(showErrors){ form.querySelector(`[name="${k}"]`)?.classList.add('error'); } } }
  if(!validateEmailAddress(c.email)){ ok=false; if(showErrors){ form.querySelector('[name="email"]')?.classList.add('error'); alert('Please enter a valid email.'); } }
  if(!cart.length){ ok=false; if(showErrors){ alert('Your cart is empty.'); } }
  const ack = document.getElementById('orderAcknowledge');
  if(!ack.checked){ ok=false; if(showErrors){ } }
  return ok;
}
document.getElementById('checkoutForm').addEventListener('input',()=>{ localStorage.setItem('hh_checkout_form', JSON.stringify(getFormData())); });
function restoreForm(){ const raw=localStorage.getItem('hh_checkout_form'); if(!raw) return;
  const data=JSON.parse(raw); const form=document.getElementById('checkoutForm');
  Object.entries(data).forEach(([k,v])=>{ const el=form.querySelector(`[name="${k}"]`); if(el!=null) el.value=v; });
}

/* Delivery segmented control */
document.getElementById('deliverySeg').addEventListener('click',(e)=>{
  const btn = e.target.closest('button[data-method]'); if(!btn) return;
  const seg = document.getElementById('deliverySeg');
  [...seg.querySelectorAll('button')].forEach(b=>b.setAttribute('aria-pressed','false'));
  btn.setAttribute('aria-pressed','true');
  selectedDeliveryMethod = btn.dataset.method === 'post' ? 'post' : 'local';
  renderCart();
});

/* ---------- Order Number ---------- */
let CURRENT_ORDER_NUMBER = null;
function generateOrderNumber(){
  const dt=new Date();
  const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,'0'), d=String(dt.getDate()).padStart(2,'0');
  const rand = Math.random().toString(36).slice(2,6).toUpperCase();
  const key='hh_on_counter_'+`${y}${m}${d}`; const n = (parseInt(localStorage.getItem(key)||'0',10) || 0) + 1;
  localStorage.setItem(key, String(n));
  return `HAH-${y}${m}${d}-${rand}${n>1?('-'+String(n).padStart(2,'0')):''}`;
}

/* Order text */
function getDeliveryLabel(){ return DELIVERY_LABELS[selectedDeliveryMethod] || 'Local pickup/delivery — FREE'; }
function buildOrderText(orderNumber){
  const c=getFormData(); const {subtotal,shipping,discountValue,grand}=computeTotals();
  const lines=cart.map(l =>
    `${l.name}${l.size?` (${l.size})`:''}${l.personalize?' + Personalised':''}${l.color?` — ${l.color.name}`:''} x ${l.qty} — ${currency(l.price*l.qty)}${l.quote?`\n   • Quote: "${l.quote}"`:''}`
  ).join('\n');
  const address=`${c.firstName} ${c.lastName}\n${c.addr1}\n${c.addr2||''}\n${c.city}${c.county?`, ${c.county}`:''}\n${c.postcode}\n${c.country}`;
  const discSection=discountValue>0?`Discount: -${currency(discountValue)}\n`:'';
  const deliverySection=`Delivery method: ${getDeliveryLabel()}\n`;
  return `ORDER SUMMARY — HealthAndHIT
Order No: ${orderNumber}
----------------------------
${lines}
----------------------------
Subtotal: ${currency(subtotal)}
${discSection}Shipping: ${currency(shipping)}
Total: ${currency(grand)}
${deliverySection}
CUSTOMER
Name: ${c.firstName} ${c.lastName}
Email: ${c.email}
Phone: ${c.phone||'-'}
Address:
${address}

${c.notes?`Notes:\n${c.notes}\n`:''}
(Please reply to confirm.)`;
}

/* Discount code */
document.getElementById('applyDiscountBtn').onclick=()=>{
  const code=(document.getElementById('discountCode').value||'').trim().toUpperCase();
  const msg=document.getElementById('discountMsg');
  if(!code){ appliedDiscount=null; msg.textContent=''; renderCart(); return; }
  if(DISCOUNT_CODES[code]){
    appliedDiscount=DISCOUNT_CODES[code];
    msg.textContent = code==='HITFREE' ? 'Free delivery applied.' : `${appliedDiscount.value}% off applied.`;
  }else{ appliedDiscount=null; msg.textContent='Invalid code.'; }
  renderCart();
};

/* ----- PayPal Smart Buttons ----- */
let lastRenderedAmount = null;
function renderPayPalButtons(){
  const host = document.getElementById('paypalButtons');
  host.style.display = 'block';
  const { grand } = computeTotals();
  const amount = (Math.round(grand*100)/100).toFixed(2);
  if (amount === lastRenderedAmount && host.firstChild) return;
  host.innerHTML = "";
  lastRenderedAmount = amount;

  paypal.Buttons({
    style: { layout:'horizontal', shape:'pill', label:'pay' },
    createOrder: (data, actions) => {
      const { grand } = computeTotals();
      const value = (Math.round(grand*100)/100).toFixed(2);
      const desc  = CURRENT_ORDER_NUMBER ? `HealthAndHIT • ${CURRENT_ORDER_NUMBER}` : 'HealthAndHIT order';
      return actions.order.create({
        purchase_units: [{
          amount: { currency_code: 'GBP', value },
          description: desc,
          invoice_id: CURRENT_ORDER_NUMBER || undefined
        }]
      });
    },
    onApprove: (data, actions) => actions.order.capture().then(details => {
      confettiBurst();
      showToast(`Thanks ${details?.payer?.name?.given_name || ''}! Payment received.`);
      cart=[]; saveCart(); renderCart();
      alert('Payment complete. We’ll confirm your order by email shortly.');
    }),
    onError: (err) => { console.error(err); alert('PayPal error — please try again.'); }
  }).render('#paypalButtons');
}

/* Email flow */
const emailBtn=document.getElementById('emailOrderBtn');
const ackBox=document.getElementById('orderAcknowledge');

emailBtn.onclick=async ()=>{
  const ackLabel = ackBox.closest('.ack');
  ackLabel.classList.remove('highlight');

  if (!ackBox.checked) {
    ackLabel.classList.add('highlight');
    setTimeout(() => ackLabel.classList.remove('highlight'), 600);
    return;
  }

  if(!validateForm(true)) return;

  CURRENT_ORDER_NUMBER = generateOrderNumber();
  const c=getFormData();
  const text=buildOrderText(CURRENT_ORDER_NUMBER);

  try { await navigator.clipboard.writeText(text); showToast('Order copied to clipboard'); } catch(e){}

  const subject=`Order ${CURRENT_ORDER_NUMBER} — ${c.firstName} ${c.lastName}`;
  const links=buildEmailLinks({subject, body:text, to:MERCHANT_EMAIL});

  window.location.href=links.mailto;
  document.getElementById('emailFallback').style.display='';
  document.getElementById('gmailLink').href=links.gmail;
  document.getElementById('outlookLink').href=links.outlook;
  document.getElementById('yahooLink').href=links.yahoo;
  document.getElementById('copyOrderBtn').onclick=async ()=>{ try{ await navigator.clipboard.writeText(text); showToast('Order copied'); }catch(e){} };

  const gate = document.getElementById('payGate');
  gate.innerHTML = `✔️ Email prepared. <b>Order ${CURRENT_ORDER_NUMBER}</b>. Now complete payment below.`;

  renderPayPalButtons();

  emailBtn.disabled = true;
  emailBtn.textContent = `Order ${CURRENT_ORDER_NUMBER} created`;

  confettiBurst();
};

/* Confetti */
function confettiBurst(){
  const canvas=document.getElementById('confetti'), ctx=canvas.getContext('2d');
  const w=canvas.width=window.innerWidth, h=canvas.height=window.innerHeight;
  const N=140, parts=[]; for(let i=0;i<N;i++) parts.push({x:Math.random()*w,y:-20-Math.random()*h*0.3,r:2+Math.random()*4,vy:2+Math.random()*3,vx:(Math.random()-0.5)*2,a:Math.random()*Math.PI,va:(Math.random()*0.2-0.1)});
  let t=0; (function step(){ ctx.clearRect(0,0,w,h); parts.forEach(p=>{ p.y+=p.vy; p.x+=p.vx; p.a+=p.va; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
    ctx.fillStyle=`hsl(${(p.x+p.y)%360},100%,60%)`; ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2); ctx.restore(); });
    if(++t<120) requestAnimationFrame(step); else ctx.clearRect(0,0,w,h); })();
}

/* Init */
function init(){
  try{
    renderProducts(); renderCart(); updateFab(); restoreForm();
  }catch(e){ console.error('Initial render error', e); }
  safeLoadInventory(); // async
  updateScrollHint();
}
init();

/* Email link builders */
function buildEmailLinks({to, subject, body}){
  const enc = s => encodeURIComponent(s);
  const mailto = `mailto:${encodeURIComponent(to)}?subject=${enc(subject)}&body=${enc(body)}`;
  const gmail  = `https://mail.google.com/mail/?view=cm&fs=1&to=${enc(to)}&su=${enc(subject)}&body=${enc(body)}`;
  const outlook= `https://outlook.live.com/mail/0/deeplink/compose?to=${enc(to)}&subject=${enc(subject)}&body=${enc(body)}`;
  const yahoo  = `https://compose.mail.yahoo.com/?to=${enc(to)}&subject=${enc(subject)}&body=${enc(body)}`;
  return { mailto, gmail, outlook, yahoo };
}
</script>
</body>
</html>
