<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HealthAndHIT — Shop (Full with Colours)</title>
<meta name="color-scheme" content="dark light">
<style>
:root { --bg:#191a1e; --panel:#23242b; --card:#26272f; --accent:#ff3939; --accent-2:#ff6b6b;
  --text:#ffffff; --muted:#c9c9cf; --ok:#48c774; --warn:#ffb020; --bad:#ff4d4d;
  --radius:16px; --shadow:0 8px 30px rgba(0,0,0,.35); }
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}
header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#1d1e23 0%,#1a1b20 100%);border-bottom:1px solid #2f3038}
.wrap{max-width:1160px;margin:0 auto;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:42px;height:42px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#ff6b6b,#ff3939 60%,#b70000);box-shadow:0 0 0 3px #2a2b31}
.brand h1{font-size:1.25rem;margin:0;font-weight:700;letter-spacing:.3px}
.basket-fab{position:fixed; right:18px; top:18px; display:flex; align-items:center; gap:10px;
  background:var(--accent); color:#fff; padding:10px 14px; border-radius:999px; box-shadow:var(--shadow);
  cursor:pointer; z-index:60; border:0; font-weight:700;}
.basket-fab .count{background:#000; padding:2px 8px; border-radius:999px; font-size:.85rem}
.hero{padding:18px 16px 8px}
.hero .notice{background:#1f2027;border:1px solid #2c2d36;border-radius:var(--radius);padding:12px 14px;color:var(--muted)}
.grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:18px;margin:16px;align-items:stretch}
.grid .full{grid-column:1 / -1}
@media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:980px){.grid{grid-template-columns:repeat(3,1fr)}}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
  overflow:hidden;border:1px solid #2c2d36;display:grid;grid-template-rows:auto 1fr;height:100%}
.media{height:180px; background:#101015; display:flex; align-items:center; justify-content:center;}
.media img{width:100%;height:100%;object-fit:contain}
.card .body{padding:14px 14px 12px;display:flex;flex-direction:column;gap:10px}
.title{font-weight:700;margin:0 0 4px}
.price{color:#ffb923;font-weight:700}
.muted{color:var(--muted);font-size:.9rem}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select, input[type="number"], input[type="text"], input[type="email"], textarea{
  width:100%; padding:10px 12px; border-radius:10px; border:1px solid #343542; background:#1f2027; color:#fff;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-accent{background:var(--accent);color:#fff}
.btn-bad{background:var(--bad);color:#fff}
.btn-block{width:100%}
.small{font-size:.92rem}
.stepper{display:inline-flex;align-items:stretch;border:1px solid #2f3040;border-radius:10px;overflow:hidden;background:#171820}
.stepper button{min-width:34px;border:0;background:#20222a;color:#fff;cursor:pointer;font-weight:800;line-height:1;display:flex;align-items:center;justify-content:center}
.stepper input{width:64px;border:0;background:transparent;color:#fff;text-align:center;padding:8px 6px;appearance:textfield}
.stepper input::-webkit-outer-spin-button,.stepper input::-webkit-inner-spin-button{appearance:none;margin:0}
.drawer{position:fixed; inset:0; display:none; z-index:70}
.drawer.open{display:block}
.backdrop{position:absolute; inset:0; background:rgba(0,0,0,.45)}
.panel{position:absolute; right:0; top:0; bottom:0; width:min(520px,100%); background:#1b1c22; border-left:1px solid #2b2c33;
  display:flex; flex-direction:column; height:100svh; max-height:100svh; }
.drawer-content{flex:1; min-height:0; overflow-y:auto; padding:0 16px 16px;}
.section-title{padding:12px 0 0 0; font-weight:700}
.cart-items{display:flex;flex-direction:column;gap:12px; padding-top:10px}
.cart-line{display:grid;grid-template-columns:1fr auto;gap:10px;border:1px solid #2b2c36;border-radius:12px;padding:12px;background:#20222a}
.cart-line .meta{font-size:.9rem;color:var(--muted)}
.totals{border-top:1px dashed #353644;margin-top:12px;padding-top:10px;color:#ddd}
.totals .row2{display:flex;justify-content:space-between;margin:6px 0}
.totals .grand{font-size:1.15rem;font-weight:800;color:#fff}
.seg{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.seg button{flex:1;border:1px solid #3a3b47;background:#1f2027;color:#fff;border-radius:10px;padding:10px;font-weight:700;cursor:pointer}
.seg button[aria-pressed="true"]{outline:2px solid var(--ok); border-color:#2a3;}
.discount-row{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
.discount-row input{flex:1}
.checkout-actions{position:sticky; bottom:0; inset-inline:0; background:#181920; border-top:1px solid #2b2c33;
  padding:12px 16px; display:flex; flex-direction:column; gap:10px;}
.gate{border:1px dashed #3a3b47; padding:10px; border-radius:10px; color:#cfcfe5; font-size:.95rem;}
.ack{display:flex;gap:10px; align-items:flex-start; background:#1f2027; border:1px solid #2c2d36; padding:10px; border-radius:10px;}
.ack.highlight { border-color: var(--bad); box-shadow: 0 0 6px var(--bad); animation: shake 0.4s ease; }
@keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-6px); } 40%, 80% { transform: translateX(6px); } }
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%); background:#000b;border:1px solid #333;padding:10px 14px;border-radius:10px;z-index:120;color:#fff;display:none}
.toast.show{display:block}
/* Colour swatches */
.swatches{display:flex; gap:10px; flex-wrap:wrap; margin-top:2px}
.swatch{width:28px; height:28px; border-radius:999px; border:2px solid #2e2f3a; position:relative; cursor:pointer; box-shadow:inset 0 0 0 2px rgba(0,0,0,.25)}
.swatch .check{display:none; position:absolute; inset:0; align-items:center; justify-content:center; font-size:14px; color:#fff; text-shadow:0 1px 2px #000}
.swatch.active .check{display:flex}
.color-chip{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid #444; background:#16171d; margin-top:6px; font-size:.85rem}
.color-dot{width:12px; height:12px; border-radius:999px; border:1px solid #333; box-shadow:inset 0 0 0 1px rgba(0,0,0,.25)}
</style>
</head>
<body>
<header>
  <div class="wrap brand">
    <div class="logo"></div>
    <h1>HealthAndHIT — Shop</h1>
  </div>
</header>

<button class="basket-fab" id="basketFab">🧺 <span class="count" id="basketCount">0</span> <span class="count" id="basketTotal">£0.00</span></button>

<section class="hero wrap">
  <div class="notice">🔴 <b>Now Open</b> — Per-size stock is live. Add items, then tap the basket to checkout.</div>
</section>

<section class="grid" id="productsGrid"></section>

<div class="drawer" id="drawer" aria-hidden="true">
  <div class="backdrop" id="drawerBackdrop" tabindex="-1"></div>
  <div class="panel" role="dialog" aria-label="Basket drawer" tabindex="-1">
    <header>
      <div class="wrap" style="display:flex;justify-content:space-between;align-items:center">
        <strong>🧺 Your Basket</strong>
        <button class="btn btn-bad small" id="closeDrawer" aria-label="Close basket">Close</button>
      </div>
    </header>
    <div class="drawer-content" id="drawerContent">
      <div class="section-title">Items</div>
      <div class="cart-items" id="cartItems"></div>
      <div class="totals">
        <div class="row2"><span>Subtotal</span><strong id="subtotal">£0.00</strong></div>
        <div class="row2"><span>Shipping</span><span id="shipping">£0.00</span></div>
        <div class="row2" id="discountRow" style="display:none;"><span>Discount</span><span id="discount">-£0.00</span></div>
        <div class="row2 grand"><span>Total</span><span id="grand">£0.00</span></div>
        <div class="section-title">Delivery method</div>
        <div class="seg" id="deliverySeg">
          <button type="button" data-method="local" aria-pressed="true">Local pickup / delivery — FREE</button>
          <button type="button" data-method="post" aria-pressed="false">Standard post — £3.99</button>
        </div>
        <div class="discount-row" style="margin-top:12px">
          <input id="discountCode" placeholder="Discount code"/>
          <button class="btn btn-accent" id="applyDiscountBtn" type="button">Apply</button>
        </div>
        <div class="muted" id="discountMsg" style="margin-top:4px;"></div>
      </div>

      <div class="section-title">Delivery details</div>
      <form class="form" id="checkoutForm" novalidate>
        <div class="grid">
          <div><input name="firstName" placeholder="First name" required></div>
          <div><input name="lastName" placeholder="Last name" required></div>
          <div class="full"><input name="email" type="email" placeholder="Email" required></div>
          <div class="full"><input name="phone" placeholder="Phone"></div>
          <div class="full"><input name="addr1" placeholder="Address line 1" required></div>
          <div class="full"><input name="addr2" placeholder="Address line 2 (optional)"></div>
          <div><input name="city" placeholder="Town/City" required></div>
          <div><input name="county" placeholder="County/Region"></div>
          <div><input name="postcode" placeholder="Postcode" required></div>
          <div><input name="country" value="United Kingdom" placeholder="Country" required></div>
          <div class="full"><textarea name="notes" rows="3" placeholder="Personalised quotes/prefered colours (optional)"></textarea></div>
        </div>
      </form>

      <label class="ack" for="orderAcknowledge" style="margin-top:12px;">
        <input type="checkbox" id="orderAcknowledge" />
        <small>I understand this is a home-run startup and accept the T&Cs.</small>
      </label>

      <div class="checkout-actions">
        <div class="gate" id="payGate">
          <b>Step 1:</b> Press <em>Send Order by Email</em>. <b>Step 2:</b> Pay using the PayPal button that appears.
        </div>
        <button class="btn btn-accent btn-block" id="emailOrderBtn">Send Order by Email</button>
        <div id="emailFallback" class="gate" style="display:none">
          Email didn’t open? Choose one:
          <div class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap">
            <a id="gmailLink"    class="btn btn-accent" target="_blank" rel="noopener">Gmail</a>
            <a id="outlookLink"  class="btn btn-accent" target="_blank" rel="noopener">Outlook.com</a>
            <a id="yahooLink"    class="btn btn-accent" target="_blank" rel="noopener">Yahoo Mail</a>
            <button id="copyOrderBtn" class="btn">Copy order text</button>
          </div>
          <div class="muted" style="margin-top:6px">The order text is copied — just paste it in your email.</div>
        </div>
        <div id="paypalButtons" style="display:none; padding-top:8px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite">Copied order to clipboard</div>

<script src="https://www.paypal.com/sdk/js?client-id=AQInbYyMMgyLAFSKTM_wB35q_8uROVBe9K_KzNyJEKeMMaQgtJ_DFEyY519B6n1HhB0Jzl0gNiq_AH5C&currency=GBP&intent=capture&enable-funding=card"></script>
<script>
const MERCHANT_EMAIL = "healthandhit@gmail.com";
const SHIPPING_FLAT=3.99, FREE_SHIPPING_OVER=60;
const DISCOUNT_CODES = { 'HIT5':{type:'percent',value:5}, 'HIT10':{type:'percent',value:10}, 'HIT20':{type:'percent',value:20}, 'HITFREE':{type:'free_shipping',value:0} };
let appliedDiscount = null;
let selectedDeliveryMethod = 'local';
const DELIVERY_LABELS = { local: 'Local pickup/delivery — FREE', post: 'Standard post — £'+SHIPPING_FLAT.toFixed(2) };
const COLOR_OPTIONS = [
  { key:'black', name:'Black', hex:'#111111' },
  { key:'white', name:'White', hex:'#ffffff' },
  { key:'red',   name:'Red',   hex:'#ff2b2b' },
  { key:'pink',  name:'Pink',  hex:'#ff6ea8' },
  { key:'blue',  name:'Blue',  hex:'#2b6cff' }
];
const DEFAULT_QUOTE_LIST = [
  "Strength grows in the moments you think you can’t go on but you do",
  "The only bad workout is the one you didn’t do",
  "Strong women lift each other up",
  "Progress not perfection",
  "You are stronger than you think",
  "Sweat now shine later",
  "Be the woman who decided to go for it",
  "Your only limit is you",
  "The body achieves what the mind believes"
];
const PRODUCTS=[
  {id:'tee',      name:'HIT T-Shirt',         price:12.00, sizes:['S','M','L','XL','2XL'], img:'tshirt.jpg', colorable:true },
  {id:'vest',     name:'HIT Vest',            price:18.00, sizes:['S','M','L','XL'],       img:'vest.png',   colorable:true },
  {id:'jumper',   name:'HIT Jumper',          price:35.00, sizes:['S','M','L','XL'],       img:'jumper.png', colorable:true },
  {id:'hoodie',   name:'HIT Hoodie',          price:38.00, sizes:['S','M','L','XL'],       img:'hoodie.png', colorable:true },
  {id:'cap',      name:'HIT Cap',             price:15.00,                                   img:'cap.png',   colorable:true },
  {id:'subcap',   name:'Sublimated Cap',      price:12.00,                                   img:'subcap.png',colorable:true },
  {id:'mug',      name:'HIT Mug',             price:12.00,                                   img:'mug.png'},
  {id:'bottle',   name:'HIT Bottle',          price:10.00,                                   img:'bottle.png'},
  {id:'keyring',  name:'HIT Keyring',         price:5.00,                                    img:'keyring.png'},
  {id:'gymbag',   name:'HIT Gym Bag',         price:12.00,                                   img:'gymbag.png'},
  {id:'towel',    name:'HIT Quick Dry Towel', price:10.00,                                   img:'towel.jpg'},
  {id:'mystery',  name:'Mystery Bundle',      price:20.00,                                   img:'mystery.png'},
  {id:'w_tshirt', name:"Women's T-Shirt",     price:12.00, sizes:['S','M','L','XL','2XL'],  img:'woman_tshirt.png', personalize:true, colorable:true},
  {id:'w_vest',   name:"Women's Vest",        price:12.00, sizes:['S','M','L','XL'],        img:'woman_vest.png',   personalize:true, colorable:true}
];
const currency=v=>'£'+(Math.round(v*100)/100).toFixed(2);
const grid=document.getElementById('productsGrid');
let cart=JSON.parse(localStorage.getItem('hh_cart')||'[]');
let INVENTORY = {};
async function loadInventory(){ try{ const res=await fetch('inventory.json',{cache:'no-store'}); if(!res.ok) throw 0; INVENTORY=await res.json()||{}; }catch(e){ INVENTORY={}; } }
const qtyFor=(pid,size)=>{ const rec=INVENTORY[pid]; if(!rec) return Infinity; if(size) return (rec[size]??0); if('ONESIZE' in rec) return rec['ONESIZE']; return 0; };
const productSoldOut=(pid,sizes)=>{ if(!sizes||!sizes.length) return qtyFor(pid,'')<=0; return sizes.every(sz=>qtyFor(pid,sz)<=0); };
function buildSizeControl(p){
  if(!p.sizes||p.sizes.length===0){ const left=qtyFor(p.id,''); const badge=(left===Infinity)?'':`<span class="muted">Stock: ${left}</span>`; return `<input type="hidden" class="size" value=""><span>${badge}</span>`; }
  const opts=p.sizes.map(sz=>{ const left=qtyFor(p.id,sz); const disabled=(left<=0)?'disabled':''; return `<option value="${sz}" ${disabled}>${sz}${left===Infinity?'':' ('+left+')'}${left<=0?' — Sold out':''}</option>`; }).join('');
  return `<select class="size"><option value="">Size</option>${opts}</select>`;
}
function buildQuoteSelectHTML(){
  const opts=['<option value="">Select a quote (optional)</option>','<option value="__PERS__">Personalised (add at checkout notes) — +£2.50</option>',...DEFAULT_QUOTE_LIST.map(q=>`<option value="${q.replace(/"/g,'&quot;')}">${q.length>70?q.slice(0,67)+'…':q}</option>`)].join('');
  return `<select class="quote-select">${opts}</select>`;
}
function buildColorSelectorHTML(){
  const dots = COLOR_OPTIONS.map(c=>{
    const ring = c.key==='white' ? 'box-shadow:inset 0 0 0 1px rgba(0,0,0,.35);' : '';
    return `<div class="swatch" data-key="${c.key}" title="${c.name}" style="background:${c.hex};${ring}"><div class="check">✓</div></div>`;
  }).join('');
  return `<div class="swatches" data-swatches>${dots}</div>`;
}
function getSelectedColour(wrap){
  const el = wrap?.querySelector('.swatch.active'); if(!el) return null;
  const key = el.getAttribute('data-key'); const cfg = COLOR_OPTIONS.find(x=>x.key===key);
  return cfg ? { key:cfg.key, name:cfg.name, hex:cfg.hex } : null;
}
function quoteKeyPart(q){ return q ? 'Q:' + encodeURIComponent(q).slice(0,140) : 'Q:-'; }
function lineKey(l){ const colorPart=l.color?`|C:${l.color.key}`:'|C:-'; return l.id+'|'+(l.size||'')+'|'+(l.personalize?'P':'-')+'|'+quoteKeyPart(l.quote||'')+colorPart; }
function addToCart(line){
  const key=lineKey(line);
  const left=qtyFor(line.id,line.size||''); if(!(left===Infinity) && line.qty>left){ alert(`Only ${left} left for that selection.`); return; }
  const existing=cart.find(l=>lineKey(l)===key);
  if(existing){ const newQty=existing.qty+line.qty; const cap=(left===Infinity)?newQty:Math.min(newQty,left); existing.qty=cap; }
  else cart.push(line);
  saveCart(); renderCart();
}
function removeFromCart(key){ cart=cart.filter(l=>lineKey(l)!==key); saveCart(); renderCart(); }
function computeTotals(){
  const subtotal=cart.reduce((s,l)=>s+l.price*l.qty,0);
  let shipping=0; if(subtotal>0){ shipping = (selectedDeliveryMethod==='local')?0:(subtotal>=FREE_SHIPPING_OVER?0:SHIPPING_FLAT); }
  let discountValue=0; if(appliedDiscount){ if(appliedDiscount.type==='percent') discountValue=subtotal*(appliedDiscount.value/100); else if(appliedDiscount.type==='free_shipping') shipping=0; }
  const grand=Math.max(0, subtotal-discountValue+shipping);
  return {subtotal,shipping,discountValue,grand};
}
function updateFab(){ const {subtotal}=computeTotals(); document.getElementById('basketCount').textContent=cart.reduce((n,l)=>n+l.qty,0); document.getElementById('basketTotal').textContent=currency(subtotal); }
function stepperHTML(initial=1){ return `<div class="stepper" data-stepper><button type="button" class="dec" aria-label="Decrease quantity">−</button><input type="number" class="qty" min="1" value="${initial}"><button type="button" class="inc" aria-label="Increase quantity">+</button></div>`; }
function renderProducts(){
  grid.innerHTML='';
  PRODUCTS.forEach(p=>{
    const soldOut=productSoldOut(p.id,p.sizes);
    const card=document.createElement('article'); card.className='card';
    card.innerHTML=`
      <div class="media"><img loading="lazy" width="600" height="180" src="${p.img}" alt="${p.name}" onerror="this.onerror=null;this.src='comingsoon.png';"></div>
      <div class="body">
        <div>
          <h3 class="title">${p.name} ${soldOut?'<span class="muted">— Sold out</span>':''}</h3>
          <div class="muted">${p.sizes?'Clothing':'Accessory'}</div>
          <div class="row"><span class="price">${currency(p.price)}</span></div>
          ${p.personalize ? `<div class="row">${buildQuoteSelectHTML()}</div>` : ''}
          ${p.colorable ? `<div class="row"><div class="muted">Colour:</div>${buildColorSelectorHTML()}</div>` : ''}
          <div class="row">${buildSizeControl(p)} ${stepperHTML(1)}</div>
        </div>
        <div class="row"><button class="btn btn-accent btn-block add" ${soldOut?'disabled':''}>${soldOut?'Sold out':'Add to Basket'}</button></div>
      </div>`;
    // size persistence
    if(p.sizes){ const sel=card.querySelector('.size'); const saved=localStorage.getItem('hh_size_'+p.id); if(saved && [...sel.options].some(o=>o.value===saved && !o.disabled)) sel.value=saved; }
    // colour behaviour
    const swatchWrap=card.querySelector('[data-swatches]');
    if(swatchWrap){
      swatchWrap.addEventListener('click',e=>{
        const el=e.target.closest('.swatch'); if(!el) return;
        const active=swatchWrap.querySelector('.swatch.active');
        if(active===el){ el.classList.remove('active'); return; }
        if(active) active.classList.remove('active');
        el.classList.add('active');
      });
    }
    // add
    card.querySelector('.add').onclick=()=>{
      const sizeEl=card.querySelector('.size'); const size=p.sizes?(sizeEl.value||''):'';
      if(p.sizes && !size){ alert('Please choose a size'); sizeEl.classList.add('error'); return; }
      sizeEl.classList.remove('error');
      const qty=Math.max(1, parseInt(card.querySelector('.qty').value||'1',10));
      const left=qtyFor(p.id,p.sizes?size:''); if(!(left===Infinity) && qty>left){ alert(`Only ${left} left for that size.`); return; }
      const rawQuote = p.personalize ? (card.querySelector('.quote-select')?.value || '') : '';
      const isPersonalised = rawQuote === '__PERS__';
      const quoteText = isPersonalised ? '' : rawQuote;
      const unitPrice = p.price + (isPersonalised ? 2.50 : 0);
      const color = swatchWrap ? getSelectedColour(swatchWrap) : null;
      addToCart({ id:p.id, name:p.name, price:unitPrice, size, qty, personalize:isPersonalised, quote:quoteText, color });
      // auto-reset selectors
      if(sizeEl) sizeEl.value="";
      if(swatchWrap){ swatchWrap.querySelectorAll('.swatch.active').forEach(x=>x.classList.remove('active')); }
      card.querySelector('.qty').value = "1";
      if(p.sizes){ localStorage.setItem('hh_size_'+p.id, size); } // still remember last used
      showToast('Added to basket');
      updateFab();
    };
    grid.appendChild(card);
  });
}
function renderCart(){
  const cartItems=document.getElementById('cartItems'); cartItems.innerHTML = cart.length ? '' : '<div class="muted">Your basket is empty.</div>';
  cart.forEach(l=>{
    const row=document.createElement('div'); row.className='cart-line'; row.dataset.key=lineKey(l);
    const colorBadge = l.color ? `<div class="color-chip"><span class="color-dot" style="background:${l.color.hex}"></span>${l.color.name}</div>` : '';
    row.innerHTML = `
      <div>
        <strong>${l.name}${l.size?` — ${l.size}`:''}${l.personalize?' + Personalised':''}</strong>
        ${colorBadge}
        <div class="meta">${currency(l.price)} × ${l.qty}</div>
        ${l.quote ? `<div class="meta"><em>Quote:</em> “${l.quote.replace(/</g,'&lt;')}”</div>` : ''}
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div style="min-width:90px;text-align:right;font-weight:800">${currency(l.price*l.qty)}</div>
        <button class="btn btn-bad small" title="Remove">✕</button>
      </div>`;
    row.querySelector('.btn-bad').onclick=()=>removeFromCart(lineKey(l));
    cartItems.appendChild(row);
  });
  const {subtotal,shipping,discountValue,grand}=computeTotals();
  document.getElementById('subtotal').textContent=currency(subtotal);
  document.getElementById('shipping').textContent=currency(shipping);
  const dr=document.getElementById('discountRow'); const dv=document.getElementById('discount');
  if(discountValue>0){ dr.style.display=''; dv.textContent='-'+currency(discountValue).replace('£',''); } else { dr.style.display='none'; }
  document.getElementById('grand').textContent=currency(grand);
  updateFab();
  if (document.getElementById('paypalButtons').style.display === 'block') renderPayPalButtons();
}
function saveCart(){ localStorage.setItem('hh_cart', JSON.stringify(cart)); updateFab(); }
function openDrawer(){ const d=document.getElementById('drawer'); d.classList.add('open'); d.setAttribute('aria-hidden','false'); }
function closeDrawer(){ const d=document.getElementById('drawer'); d.classList.remove('open'); d.setAttribute('aria-hidden','true'); }
document.getElementById('basketFab').onclick=openDrawer;
document.getElementById('closeDrawer').onclick=closeDrawer;
document.getElementById('drawerBackdrop').onclick=closeDrawer;
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && document.getElementById('drawer').classList.contains('open')) closeDrawer(); });
document.addEventListener('click',(e)=>{
  const btn=e.target.closest('.stepper .inc, .stepper .dec'); if(!btn) return;
  const wrap=btn.closest('.stepper'); const input=wrap.querySelector('input.qty');
  let val=Math.max(1, parseInt(input.value||'1',10));
  if(btn.classList.contains('inc')) val++; else val=Math.max(1,val-1);
  input.value=String(val);
},{passive:true});
document.getElementById('deliverySeg').addEventListener('click',(e)=>{
  const btn = e.target.closest('button[data-method]'); if(!btn) return;
  const seg = document.getElementById('deliverySeg');
  [...seg.querySelectorAll('button')].forEach(b=>b.setAttribute('aria-pressed','false'));
  btn.setAttribute('aria-pressed','true');
  selectedDeliveryMethod = btn.dataset.method === 'post' ? 'post' : 'local';
  renderCart();
});
document.getElementById('applyDiscountBtn').onclick=()=>{
  const code=(document.getElementById('discountCode').value||'').trim().toUpperCase();
  const msg=document.getElementById('discountMsg');
  if(!code){ appliedDiscount=null; msg.textContent=''; renderCart(); return; }
  if(DISCOUNT_CODES[code]){ appliedDiscount=DISCOUNT_CODES[code]; msg.textContent = code==='HITFREE' ? 'Free delivery applied.' : `${appliedDiscount.value}% off applied.`; } else { appliedDiscount=null; msg.textContent='Invalid code.'; }
  renderCart();
};
let CURRENT_ORDER_NUMBER = null;
function generateOrderNumber(){
  const dt=new Date();
  const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,'0'), d=String(dt.getDate()).padStart(2,'0');
  const rand = Math.random().toString(36).slice(2,6).toUpperCase();
  return `HAH-${y}${m}${d}-${rand}`;
}
function getDeliveryLabel(){ return DELIVERY_LABELS[selectedDeliveryMethod] || 'Local pickup/delivery — FREE'; }
function buildOrderText(orderNumber){
  const c=Object.fromEntries(new FormData(document.getElementById('checkoutForm')).entries());
  const {subtotal,shipping,discountValue,grand}=computeTotals();
  const lines=cart.map(l => {
    const base = `${l.name}${l.size?` (${l.size})`:''}${l.personalize?' + Personalised':''}${l.color?` — ${l.color.name}`:''} x ${l.qty} — ${currency(l.price*l.qty)}`;
    const quote = l.quote ? `\n   • Quote: "${l.quote}"` : '';
    return base + quote;
  }).join('\n');
  const address=`${c.firstName||''} ${c.lastName||''}\n${c.addr1||''}\n${c.addr2||''}\n${c.city||''}${c.county?`, ${c.county}`:''}\n${c.postcode||''}\n${c.country||''}`;
  const discSection=discountValue>0?`Discount: -${currency(discountValue)}\n`:'';
  const deliverySection=`Delivery method: ${getDeliveryLabel()}\n`;
  return `ORDER SUMMARY — HealthAndHIT
Order No: ${orderNumber}
----------------------------
${lines}
----------------------------
Subtotal: ${currency(subtotal)}
${discSection}Shipping: ${currency(shipping)}
Total: ${currency(grand)}
${deliverySection}
CUSTOMER
Name: ${c.firstName||''} ${c.lastName||''}
Email: ${c.email||''}
Phone: ${c.phone||'-'}
Address:
${address}

${c.notes?`Notes:\n${c.notes}\n`:''}
(Please reply to confirm.)`;
}
function buildEmailLinks({to, subject, body}){
  const enc=s=>encodeURIComponent(s);
  return {
    mailto:  `mailto:${enc(to)}?subject=${enc(subject)}&body=${enc(body)}`,
    gmail:   `https://mail.google.com/mail/?view=cm&fs=1&to=${enc(to)}&su=${enc(subject)}&body=${enc(body)}`,
    outlook: `https://outlook.live.com/mail/0/deeplink/compose?to=${enc(to)}&subject=${enc(subject)}&body=${enc(body)}`,
    yahoo:   `https://compose.mail.yahoo.com/?to=${enc(to)}&subject=${enc(subject)}&body=${enc(body)}`
  };
}
function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); }
function renderPayPalButtons(){
  const host = document.getElementById('paypalButtons'); host.style.display='block';
  const { grand } = computeTotals();
  const amount = (Math.round(grand*100)/100).toFixed(2);
  host.innerHTML = "";
  paypal.Buttons({
    style: { layout:'horizontal', shape:'pill', label:'pay' },
    createOrder: (data, actions) => {
      const { grand } = computeTotals();
      const value = (Math.round(grand*100)/100).toFixed(2);
      const desc  = CURRENT_ORDER_NUMBER ? `HealthAndHIT • ${CURRENT_ORDER_NUMBER}` : 'HealthAndHIT order';
      return actions.order.create({ purchase_units: [{ amount: { currency_code: 'GBP', value }, description: desc, invoice_id: CURRENT_ORDER_NUMBER || undefined }] });
    },
    onApprove: (data, actions) => actions.order.capture().then(details => { showToast(`Thanks ${details?.payer?.name?.given_name || ''}! Payment received.`); cart=[]; saveCart(); renderCart(); alert('Payment complete. We’ll confirm your order by email shortly.'); }),
    onError: (err) => { console.error(err); alert('PayPal error — please try again.'); }
  }).render('#paypalButtons');
}
const emailBtn=document.getElementById('emailOrderBtn'); const ackBox=document.getElementById('orderAcknowledge');
emailBtn.onclick=async ()=>{
  const ackLabel = ackBox.closest('.ack'); ackLabel.classList.remove('highlight');
  if (!ackBox.checked) { ackLabel.classList.add('highlight'); setTimeout(()=>ackLabel.classList.remove('highlight'), 600); return; }
  if(!cart.length){ alert('Your cart is empty.'); return; }
  CURRENT_ORDER_NUMBER = generateOrderNumber();
  const text=buildOrderText(CURRENT_ORDER_NUMBER);
  try { await navigator.clipboard.writeText(text); showToast('Order copied to clipboard'); } catch(e){}
  const c=Object.fromEntries(new FormData(document.getElementById('checkoutForm')).entries());
  const subject=`Order ${CURRENT_ORDER_NUMBER} — ${c.firstName||''} ${c.lastName||''}`;
  const links=buildEmailLinks({subject, body:text, to:MERCHANT_EMAIL});
  window.location.href=links.mailto;
  const fb=document.getElementById('emailFallback'); fb.style.display='block';
  document.getElementById('gmailLink').href=links.gmail;
  document.getElementById('outlookLink').href=links.outlook;
  document.getElementById('yahooLink').href=links.yahoo;
  document.getElementById('copyOrderBtn').onclick=async ()=>{ try{ await navigator.clipboard.writeText(text); showToast('Order copied'); }catch(e){} };
  document.getElementById('payGate').innerHTML = `✔️ Email prepared. <b>Order ${CURRENT_ORDER_NUMBER}</b>. Now complete payment below.`;
  renderPayPalButtons();
  emailBtn.disabled = true; emailBtn.textContent = `Order ${CURRENT_ORDER_NUMBER} created`;
};
function updateFab(){ const {subtotal}=computeTotals(); document.getElementById('basketCount').textContent=cart.reduce((n,l)=>n+l.qty,0); document.getElementById('basketTotal').textContent=currency(subtotal); }
async function init(){ await loadInventory(); renderProducts(); renderCart(); updateFab(); }
init();
</script>
</body>
</html>
