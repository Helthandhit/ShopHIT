<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HealthAndHIT — Shop</title>
<meta name="color-scheme" content="dark light">

<style>
:root {
  --bg:#191a1e; --panel:#23242b; --card:#26272f; --accent:#ff3939; --accent-2:#ff6b6b;
  --text:#ffffff; --muted:#c9c9cf; --ok:#48c774; --warn:#ffb020; --bad:#ff4d4d;
  --radius:16px; --shadow:0 8px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}

/* Header */
header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#1d1e23 0%,#1a1b20 100%);border-bottom:1px solid #2f3038}
.wrap{max-width:1160px;margin:0 auto;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:42px;height:42px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#ff6b6b,#ff3939 60%,#b70000);box-shadow:0 0 0 3px #2a2b31}
.brand h1{font-size:1.25rem;margin:0;font-weight:700;letter-spacing:.3px}

/* Basket FAB */
.basket-fab{
  position:fixed; right:18px; top:18px; display:flex; align-items:center; gap:10px;
  background:var(--accent); color:#fff; padding:10px 14px; border-radius:999px; box-shadow:var(--shadow);
  cursor:pointer; z-index:60; border:0; font-weight:700;
}
.basket-fab .count{background:#000; padding:2px 8px; border-radius:999px; font-size:.85rem}

/* Hero notice */
.hero{padding:18px 16px 8px}
.hero .notice{background:#1f2027;border:1px solid #2c2d36;border-radius:var(--radius);padding:12px 14px;color:var(--muted)}

/* Product grid */
.grid{
  display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:18px;margin:16px;align-items:stretch
}
@media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:980px){.grid{grid-template-columns:repeat(3,1fr)}}

.card{
  background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
  overflow:hidden;border:1px solid #2c2d36;display:grid;grid-template-rows:auto 1fr;height:100%
}
.media{
  height:180px; background:#101015; display:flex; align-items:center; justify-content:center;
}
.media img{width:100%;height:100%;object-fit:contain}

.card .body{
  padding:14px 14px 12px;display:flex;flex-direction:column;gap:10px
}
.title{font-weight:700;margin:0 0 4px}
.price{color:#ffb923;font-weight:700}
.muted{color:var(--muted);font-size:.9rem}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select, input[type="number"], input[type="text"], input[type="email"], textarea{
  width:100%; padding:10px 12px; border-radius:10px; border:1px solid #343542; background:#1f2027; color:#fff;
}
.qty{width:110px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-accent{background:var(--accent);color:#fff}
.btn-bad{background:var(--bad);color:#fff}
.btn-block{width:100%}
.small{font-size:.92rem}

/* Drawer */
.drawer{position:fixed; inset:0; display:none; z-index:70}
.drawer.open{display:block}
.backdrop{position:absolute; inset:0; background:rgba(0,0,0,.45)}
.panel{
  position:absolute; right:0; top:0; bottom:0;
  width:min(520px,100%); background:#1b1c22; border-left:1px solid #2b2c33;
  display:flex; flex-direction:column; height:100svh; max-height:100svh;
}
/* scrollable area inc. cart + totals + form */
.drawer-content{
  flex:1; min-height:0;
  overflow-y:auto; -webkit-overflow-scrolling:touch;
  padding:0 16px 16px;
}
.panel header .wrap{padding:14px 16px}
.section-title{padding:12px 0 0 0; font-weight:700}

/* Lines */
.cart-items{display:flex;flex-direction:column;gap:12px; padding-top:10px}
.cart-line{
  display:grid;grid-template-columns:1fr auto;gap:10px;
  border:1px solid #2b2c36;border-radius:12px;padding:12px;background:#20222a
}
.cart-line .meta{font-size:.9rem;color:var(--muted)}

/* Totals */
.totals{border-top:1px dashed #353644;margin-top:12px;padding-top:10px;color:#ddd}
.totals .row2{display:flex;justify-content:space-between;margin:6px 0}
.totals .grand{font-size:1.15rem;font-weight:800;color:#fff}

/* Shipping mode selector */
.ship-mode{display:flex;gap:10px;align-items:center;margin:8px 0 4px}
.ship-mode label{display:flex;align-items:center;gap:6px;font-size:.95rem;color:#e3e3ea}

/* Free shipping progress */
.progress-wrap{margin-top:10px;background:#1e1f26;border:1px solid #2d2e39;border-radius:10px;overflow:hidden}
.progress-bar{height:10px;width:0}
.progress-msg{font-size:.9rem;color:#cfcfe5;margin:6px 0 0}

/* Discount row */
.discount-row{display:flex;gap:8px;align-items:center;margin-top:10px}
.discount-row input{flex:1}

/* CoC checkbox */
#cocWrap{display:none;margin-top:8px;color:#ffdca8}
#cocWrap label{display:flex;align-items:center;gap:8px}

/* Address form */
.form .grid{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:680px){.form .grid{grid-template-columns:1fr 1fr}}
.form .grid .full{grid-column:1/-1}
input.error, textarea.error, select.error{outline:2px solid var(--bad);}

/* Sticky action bar */
.checkout-actions{
  position:sticky; bottom:0; inset-inline:0;
  background:#181920; border-top:1px solid #2b2c33;
  padding:12px 16px; display:flex; flex-direction:column; gap:10px;
}
.gate{
  border:1px dashed #3a3b47; padding:10px; border-radius:10px; color:#cfcfe5; font-size:.95rem;
}

/* Popup + toast */
#discountPopup {
  position: fixed; top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,.7); display:flex; align-items:center; justify-content:center;
  z-index: 999;
}
#discountPopup .box {
  background: var(--card); padding: 20px; border-radius: var(--radius);
  max-width: 320px; text-align:center; box-shadow: var(--shadow);
}
#discountPopup button {
  margin-top: 10px; padding: 8px 14px; border: none;
  background: var(--accent); color: #fff; border-radius: 8px; cursor: pointer;
}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
  background:#000b;border:1px solid #333;padding:10px 14px;border-radius:10px;z-index:120;color:#fff;display:none;cursor:pointer}
.toast.show{display:block}

/* Pulse for PayPal stage */
.pulse{animation:pulse 1.2s infinite}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(255,57,57,.6)}
  70%{box-shadow:0 0 0 12px rgba(255,57,57,0)}
  100%{box-shadow:0 0 0 0 rgba(255,57,57,0)}
}

/* Confetti canvas (optional) */
#confetti{position:fixed;inset:0;pointer-events:none;z-index:200}

/* FAB bump animation */
.basket-fab.bump { animation: bump 300ms ease; }
@keyframes bump {
  0% { transform: scale(1); }
  10% { transform: scale(1.06); }
  30% { transform: scale(1.12); }
  100% { transform: scale(1); }
}
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<header>
  <div class="wrap brand">
    <div class="logo"></div>
    <h1>HealthAndHIT — Shop</h1>
  </div>
</header>

<button class="basket-fab" id="basketFab">🧺 <span class="count" id="basketCount">0</span> <span class="count" id="basketTotal">£0.00</span></button>

<section class="hero wrap">
  <div class="notice">🔴 <b>Now Open</b> — Add items, then tap the basket to checkout.</div>
</section>

<section class="grid" id="productsGrid"></section>

<!-- Drawer -->
<div class="drawer" id="drawer" aria-hidden="true">
  <div class="backdrop" id="drawerBackdrop" tabindex="-1"></div>
  <div class="panel" role="dialog" aria-label="Basket drawer" tabindex="-1">
    <header>
      <div class="wrap" style="display:flex;justify-content:space-between;align-items:center">
        <strong>🧺 Your Basket</strong>
        <button class="btn btn-bad small" id="closeDrawer" aria-label="Close basket">Close</button>
      </div>
    </header>

    <div class="drawer-content" id="drawerContent">
      <div class="section-title">Items</div>
      <div class="cart-items" id="cartItems"></div>

      <div class="totals">
        <div class="row2"><span>Subtotal</span><strong id="subtotal">£0.00</strong></div>

        <!-- Shipping mode -->
        <div class="ship-mode" role="radiogroup" aria-label="Shipping method">
          <label><input type="radio" name="shipMode" value="delivery" id="shipDelivery" checked> Delivery</label>
          <label><input type="radio" name="shipMode" value="pickup" id="shipPickup"> Local Pickup (£0)</label>
        </div>

        <div class="row2"><span>Shipping</span><span id="shipping">£0.00</span></div>
        <div class="row2" id="discountRow" style="display:none;"><span>Discount</span><span id="discount">-£0.00</span></div>
        <div class="row2 grand"><span>Total</span><span id="grand">£0.00</span></div>

        <!-- Free shipping progress -->
        <div class="progress-wrap">
          <div class="progress-bar" id="shipProgress"></div>
        </div>
        <div class="progress-msg" id="shipMsg"></div>

        <!-- Cash on collection checkbox (only for pickup) -->
        <div id="cocWrap">
          <label><input type="checkbox" id="cashOnCollection"> Pay cash on collection</label>
        </div>

        <!-- Discount code input -->
        <div class="discount-row" style="margin-top:12px">
          <input id="discountCode" placeholder="Discount code"/>
          <button class="btn btn-accent" id="applyDiscountBtn" type="button">Apply</button>
        </div>
        <div class="muted" id="discountMsg" style="margin-top:4px;"></div>
      </div>

      <div class="section-title">Delivery details</div>
      <form class="form" id="checkoutForm" novalidate>
        <div class="grid">
          <div><input name="firstName" placeholder="First name" required></div>
          <div><input name="lastName" placeholder="Last name" required></div>
          <div class="full"><input name="email" type="email" placeholder="Email" required></div>
          <div class="full"><input name="phone" placeholder="Phone"></div>
          <div class="full"><input name="addr1" placeholder="Address line 1" required></div>
          <div class="full"><input name="addr2" placeholder="Address line 2 (optional)"></div>
          <div><input name="city" placeholder="Town/City" required></div>
          <div><input name="county" placeholder="County/Region"></div>
          <div><input name="postcode" placeholder="Postcode" required></div>
          <div><input name="country" value="United Kingdom" placeholder="Country" required></div>
          <div class="full"><textarea name="notes" rows="3" placeholder="Order notes (optional)"></textarea></div>
        </div>
      </form>
    </div>

    <div class="checkout-actions">
      <!-- Step 1 gate -->
      <div class="gate" id="payGate">
        <b>Step 1:</b> Press <em>Send Order by Email</em> below to confirm your details.<br/>
        A PayPal button will appear afterwards.
      </div>

      <!-- Single button; becomes PayPal after email -->
      <button class="btn btn-accent btn-block" id="emailOrderBtn">Send Order by Email</button>
    </div>
  </div>
</div>

<!-- Discount popup -->
<div id="discountPopup">
  <div class="box">
    <h2>💪 Thanks for Visiting!</h2>
    <p>Use code <b>HIT10</b> for 10% off your first order.</p>
    <p><em>“Hit your goals with HealthAndHIT”</em></p>
    <button onclick="document.getElementById('discountPopup').style.display='none'">Close</button>
  </div>
</div>

<!-- Make toast SR-friendly + clickable for Undo -->
<div class="toast" id="toast" role="status" aria-live="polite">Copied order to clipboard</div>

<script>
/* -------- Settings -------- */
const MERCHANT_EMAIL = "healthandhit@gmail.com";
/* Short paypal.me for reliable prefilled amounts */
const PAYPAL_ME_BASE = "https://paypal.me/healthandhit/";
const SHIPPING_FLAT=3.99, FREE_SHIPPING_OVER=60;

/* Toggle drawer on add (off) */
const OPEN_DRAWER_ON_ADD = false;

/* Discount codes */
const DISCOUNT_CODES = {
  'HIT5':   {type:'percent', value:5},
  'HIT10':  {type:'percent', value:10},
  'HIT20':  {type:'percent', value:20},
  'HITFREE':{type:'free_shipping', value:0}
};
let appliedDiscount = null;

/* Shipping mode & CoC */
let shipMode = localStorage.getItem('hh_ship_mode') || 'delivery'; // 'delivery' | 'pickup'

let cart=JSON.parse(localStorage.getItem('hh_cart')||'[]');

/* Helpers */
const currency=v=>'£'+(Math.round(v*100)/100).toFixed(2);
const grid=document.getElementById('productsGrid');

/* Toast */
let toastTimer=null;
function showToast(msg='Copied order to clipboard', onClick=null){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show'); t.onclick=null;
  if(onClick){ t.onclick=()=>{ onClick(); hideToast(); }; }
  clearTimeout(toastTimer); toastTimer=setTimeout(hideToast, 2000);
}
function hideToast(){ const t=document.getElementById('toast'); t.classList.remove('show'); t.onclick=null; }
function bumpFab(){
  const fab = document.getElementById('basketFab');
  fab.classList.remove('bump'); void fab.offsetWidth; fab.classList.add('bump');
  if(navigator.vibrate) navigator.vibrate(20);
}
function saveCart(){ localStorage.setItem('hh_cart', JSON.stringify(cart)); updateFab(); }

/* last added tracking for Undo */
let lastAddedKey = null;

/* Add to cart */
function addToCart(line){
  const key=line.id+'|'+(line.size||'');
  const existing=cart.find(l=>(l.id+'|'+(l.size||''))===key);
  const wasEmpty = cart.length === 0;

  if(existing){ existing.qty+=line.qty; lastAddedKey = key; }
  else { cart.push(line); lastAddedKey = key; }

  if(line.size){ localStorage.setItem('hh_size_'+line.id, line.size); }

  saveCart(); renderCart();

  showToast(`Added ${line.name}${line.size ? ' ' + line.size : ''} — Undo`, ()=>{
    removeFromCart(lastAddedKey); lastAddedKey = null; showToast('Removed');
  });
  bumpFab();

  if (OPEN_DRAWER_ON_ADD && wasEmpty) openDrawer();
}

function removeFromCart(key){ cart=cart.filter(l=>(l.id+'|'+(l.size||''))!==key); saveCart(); renderCart(); }

/* Totals with shipping mode */
function computeTotals(){
  const subtotal=cart.reduce((s,l)=>s+l.price*l.qty,0);
  let shipping = 0;
  if (shipMode === 'pickup') {
    shipping = 0;
  } else {
    shipping = subtotal===0 ? 0 : (subtotal>=FREE_SHIPPING_OVER ? 0 : SHIPPING_FLAT);
  }
  let discountValue = 0;
  if(appliedDiscount){
    if(appliedDiscount.type==='percent'){ discountValue = subtotal * (appliedDiscount.value/100); }
    else if(appliedDiscount.type==='free_shipping'){ shipping = 0; }
  }
  const grand = Math.max(0, subtotal - discountValue + shipping);
  return {subtotal, shipping, discountValue, grand};
}

function updateFab(){
  const {subtotal}=computeTotals();
  document.getElementById('basketCount').textContent=cart.reduce((n,l)=>n+l.qty,0);
  document.getElementById('basketTotal').textContent=currency(subtotal);
}

function renderProducts(){
  grid.innerHTML='';
  const PRODUCTS=[
    {id:'tee',      name:'HIT T-Shirt',         price:12.00, sizes:['S','M','L','XL','2XL'], img:'tshirt.jpg'},
    {id:'vest',     name:'HIT Vest',            price:18.00, sizes:['S','M','L','XL'],       img:'vest.png'},
    {id:'jumper',   name:'HIT Jumper',          price:35.00, sizes:['S','M','L','XL'],       img:'jumper.png'},
    {id:'hoodie',   name:'HIT Hoodie',          price:38.00, sizes:['S','M','L','XL'],       img:'hoodie.png'},
    {id:'cap',      name:'HIT Cap',             price:15.00,                                   img:'cap.png'},
    {id:'subcap',   name:'Sublimated Cap',      price:12.00,                                   img:'subcap.png'},
    {id:'mug',      name:'HIT Mug',             price:12.00,                                   img:'mug.png'},
    {id:'bottle',   name:'HIT Bottle',          price:10.00,                                   img:'bottle.png'},
    {id:'keyring',  name:'HIT Keyring',         price:5.00,                                    img:'keyring.png'},
    {id:'gymbag',   name:'HIT Gym Bag',         price:12.00,                                   img:'gymbag.png'},
    {id:'towel',    name:'HIT Quick Dry Towel', price:10.00,                                   img:'towel.jpg'},
    {id:'mystery',  name:'Mystery Bundle',      price:20.00,                                   img:'mystery.png'}
  ];
  PRODUCTS.forEach(p=>{
    const card=document.createElement('article');
    card.className='card';
    card.innerHTML=`
      <div class="media">
        <img loading="lazy" width="600" height="180" src="${p.img}" alt="${p.name}" onerror="this.onerror=null;this.src='comingsoon.png';">
      </div>
      <div class="body">
        <div>
          <h3 class="title">${p.name}</h3>
          <div class="muted">${p.sizes?'Clothing':'Accessory'}</div>
          <div class="row"><span class="price">${currency(p.price)}</span></div>
          <div class="row">
            ${p.sizes
              ? `<select class="size"><option value="">Size</option>${p.sizes.map(s=>`<option>${s}</option>`).join('')}</select>`
              : `<input type="hidden" class="size">`}
            <input type="number" class="qty" min="1" value="1">
          </div>
        </div>
        <div class="row"><button class="btn btn-accent btn-block add">Add to Basket</button></div>
      </div>`;

    if(p.sizes){
      const saved = localStorage.getItem('hh_size_'+p.id);
      if(saved){
        const sel = card.querySelector('.size');
        if([...sel.options].some(o=>o.value===saved)) sel.value = saved;
      }
    }

    let adding = false;
    card.querySelector('.add').onclick=()=>{
      if (adding) return; adding = true;
      const sizeEl=card.querySelector('.size');
      const size=p.sizes?(sizeEl.value||''):'';
      if(p.sizes && !size){ alert('Please choose a size'); sizeEl.classList.add('error'); adding=false; return; }
      sizeEl.classList.remove('error');
      const qty=Math.max(1, parseInt(card.querySelector('.qty').value||'1',10));
      addToCart({id:p.id,name:p.name,price:p.price,size,qty});
      setTimeout(()=>adding=false,300);
    };
    grid.appendChild(card);
  });
}

/* Render cart & totals */
function renderCart(){
  const cartItems=document.getElementById('cartItems');
  cartItems.innerHTML=cart.length?'' : '<div class="note">Your basket is empty.</div>';
  cart.forEach(l=>{
    const key=l.id+'|'+(l.size||'');
    const row=document.createElement('div');
    row.className='cart-line';
    row.innerHTML=`
      <div>
        <strong>${l.name}${l.size?` — ${l.size}`:''}</strong>
        <div class="meta">${currency(l.price)} ×&nbsp;
          <input type="number" min="1" value="${l.qty}" style="width:70px;background:#171820;border:1px solid #2f3040;color:#fff;border-radius:8px;padding:6px 8px">
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div style="min-width:90px;text-align:right;font-weight:800">${currency(l.price*l.qty)}</div>
        <button class="btn btn-bad small" title="Remove">✕</button>
      </div>`;
    row.querySelector('input').oninput=e=>{ l.qty=Math.max(1,parseInt(e.target.value||'1',10)); saveCart(); renderCart(); };
    row.querySelector('.btn-bad').onclick=()=>removeFromCart(key);
    cartItems.appendChild(row);
  });

  const {subtotal,shipping,discountValue,grand}=computeTotals();
  document.getElementById('subtotal').textContent=currency(subtotal);
  document.getElementById('shipping').textContent=currency(shipping);
  document.getElementById('grand').textContent=currency(grand);

  const dr=document.getElementById('discountRow');
  const dv=document.getElementById('discount');
  if(discountValue>0){ dr.style.display=''; dv.textContent='-'+currency(discountValue).replace('£',''); }
  else{ dr.style.display='none'; }

  // Free shipping progress / pickup state
  const prog = document.getElementById('shipProgress');
  const msg  = document.getElementById('shipMsg');
  if (shipMode === 'pickup') {
    prog.style.width = '100%';
    prog.style.background = 'linear-gradient(90deg,#48c774,#86efac)';
    msg.textContent = '🏃 Local pickup selected — no shipping charged.';
  } else {
    const need = Math.max(0, FREE_SHIPPING_OVER - subtotal);
    const pct  = Math.min(100, Math.round((subtotal/Math.max(1,FREE_SHIPPING_OVER))*100));
    prog.style.width = pct + '%';
    prog.style.background = need === 0 ? 'linear-gradient(90deg,#48c774,#86efac)' : 'linear-gradient(90deg,#ff6b6b,#ff3939)';
    msg.textContent = need === 0 ? '🎉 You’ve unlocked free shipping!' : `£${need.toFixed(2)} away from free shipping`;
  }

  // Show/Hide CoC checkbox
  const cocWrap = document.getElementById('cocWrap');
  cocWrap.style.display = (shipMode === 'pickup') ? 'block' : 'none';

  updateFab();
}

/* Drawer UX + a11y */
function openDrawer(){
  const drawerEl = document.getElementById('drawer');
  drawerEl.classList.add('open'); drawerEl.setAttribute('aria-hidden','false');
  drawerEl.querySelector('.panel').focus?.();
}
function closeDrawer(){
  const drawerEl = document.getElementById('drawer');
  drawerEl.classList.remove('open'); drawerEl.setAttribute('aria-hidden','true');
  document.getElementById('basketFab').focus?.();
}
document.getElementById('basketFab').onclick=openDrawer;
document.getElementById('closeDrawer').onclick=closeDrawer;
document.getElementById('drawerBackdrop').onclick=closeDrawer;
document.addEventListener('keydown', (e)=>{
  const drawerEl=document.getElementById('drawer');
  if(e.key === 'Escape' && drawerEl.classList.contains('open')) closeDrawer();
});

/* Prevent scroll-wheel changing qty accidentally on desktop */
document.addEventListener('wheel', (e)=>{
  const el = document.activeElement;
  if(el && el.type === 'number'){ el.blur(); }
}, {passive:true});

/* Form */
function getFormData(){
  const fd=new FormData(document.getElementById('checkoutForm'));
  return Object.fromEntries(fd.entries());
}
function validateEmailAddress(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'').trim()); }
function validateForm(showErrors=true){
  const form=document.getElementById('checkoutForm');
  const c=getFormData();
  const required=['firstName','lastName','email','addr1','city','postcode','country'];
  let ok=true;
  form.querySelectorAll('input,textarea,select').forEach(el=>el.classList.remove('error'));
  for(const k of required){
    if(!String(c[k]||'').trim()){ ok=false; if(showErrors){ const el=form.querySelector(`[name="${k}"]`); el&&el.classList.add('error'); } }
  }
  if(!validateEmailAddress(c.email)){ ok=false; if(showErrors){ form.querySelector('[name="email"]').classList.add('error'); alert('Please enter a valid email.'); } }
  if(!cart.length){ ok=false; if(showErrors){ alert('Your cart is empty.'); } }
  return ok;
}

/* Persist checkout form */
document.getElementById('checkoutForm').addEventListener('input', ()=>{
  localStorage.setItem('hh_checkout_form', JSON.stringify(getFormData()));
});
function restoreForm(){
  const raw = localStorage.getItem('hh_checkout_form');
  if(!raw) return;
  const data = JSON.parse(raw);
  const form = document.getElementById('checkoutForm');
  Object.entries(data).forEach(([k,v])=>{
    const el = form.querySelector(`[name="${k}"]`);
    if(el!=null) el.value = v;
  });
}

/* Build order text */
function buildOrderText(){
  const c=getFormData();
  const {subtotal,shipping,discountValue,grand}=computeTotals();
  const lines=cart.map(l=>`${l.name}${l.size?` (${l.size})`:''} x ${l.qty} — ${currency(l.price*l.qty)}`).join('\n');
  const address = `${c.firstName} ${c.lastName}\n${c.addr1}\n${c.addr2||''}\n${c.city}${c.county?`, ${c.county}`:''}\n${c.postcode}\n${c.country}`;
  const discSection = discountValue>0 ? `Discount: -${currency(discountValue)}\n` : '';
  const payPref = (shipMode==='pickup' && document.getElementById('cashOnCollection')?.checked)
    ? 'Cash on Collection'
    : 'PayPal';
  return `ORDER SUMMARY — HealthAndHIT
----------------------------
${lines}
----------------------------
Subtotal: ${currency(subtotal)}
${discSection}Shipping: ${currency(shipping)}
Total: ${currency(grand)}

CUSTOMER
Name: ${c.firstName} ${c.lastName}
Email: ${c.email}
Phone: ${c.phone||'-'}
Address:
${address}

Shipping method: ${shipMode==='pickup'?'Local Pickup':'Delivery'}
Payment preference: ${payPref}

${c.notes?`Notes:\n${c.notes}\n`:''}(Please reply to confirm & arrange payment.)`;
}

/* Discount code */
document.getElementById('applyDiscountBtn').onclick=()=>{
  const code = (document.getElementById('discountCode').value||'').trim().toUpperCase();
  const msg = document.getElementById('discountMsg');
  if(!code){ appliedDiscount=null; msg.textContent=''; renderCart(); return; }
  if(DISCOUNT_CODES[code]){
    appliedDiscount = DISCOUNT_CODES[code];
    msg.textContent = code==='HITFREE' ? 'Free shipping applied.' : `${appliedDiscount.value}% off applied.`;
  }else{
    appliedDiscount = null; msg.textContent='Invalid code.';
  }
  renderCart();
};

/* Shipping mode UI */
const shipDeliveryEl = document.getElementById('shipDelivery');
const shipPickupEl   = document.getElementById('shipPickup');
function applyShipModeUI(){
  if (shipMode==='pickup'){ shipPickupEl.checked=true; shipDeliveryEl.checked=false; }
  else { shipDeliveryEl.checked=true; shipPickupEl.checked=false; }
  localStorage.setItem('hh_ship_mode', shipMode);
  renderCart();
}
shipDeliveryEl.onchange = ()=>{ if(shipDeliveryEl.checked){ shipMode='delivery'; applyShipModeUI(); } };
shipPickupEl.onchange   = ()=>{ if(shipPickupEl.checked){ shipMode='pickup';   applyShipModeUI(); } };

/* Email first, then switch to PayPal button */
const emailBtn = document.getElementById('emailOrderBtn');

emailBtn.onclick = async ()=>{
  if(!validateForm(true)) return;
  const c=getFormData();
  const text=buildOrderText();

  try{ await navigator.clipboard.writeText(text); showToast('Order copied. Opening email…'); }catch(e){ /* ignore */ }

  const mailto=`mailto:${encodeURIComponent(MERCHANT_EMAIL)}?subject=${encodeURIComponent('New Order — '+c.firstName+' '+c.lastName)}&body=${encodeURIComponent(text)}`;
  window.location.href=mailto;

  // Stage message
  document.getElementById('payGate').innerHTML = '✔️ Email opened. <b>Step 2:</b> Click <em>Pay with PayPal</em> to complete payment, or bring cash if you selected collection.';
  turnButtonIntoPaypal();
  confettiBurst();
};

/* PayPal: robust amount + same-tab navigation */
function turnButtonIntoPaypal(){
  const {grand}=computeTotals();
  emailBtn.textContent = `Pay with PayPal — ${currency(grand)}`;
  emailBtn.classList.add('pulse');
  emailBtn.onclick = ()=>{
    const {grand} = computeTotals();            // re-check at click
    let amount = Math.max(0, grand);            // guard
    amount = (Math.round(amount * 100) / 100)   // normalize
              .toFixed(2)
              .replace(',', '.');               // locale safety
    const url = PAYPAL_ME_BASE + amount;
    try { window.location.href = url; } catch(e) { window.open(url, '_blank'); }
  };
}

/* Confetti */
function confettiBurst(){
  const canvas=document.getElementById('confetti');
  const ctx=canvas.getContext('2d');
  const w=canvas.width=window.innerWidth, h=canvas.height=window.innerHeight;
  const N=140, parts=[];
  for(let i=0;i<N;i++){
    parts.push({
      x:Math.random()*w, y:-20-Math.random()*h*0.3,
      r:2+Math.random()*4, vy:2+Math.random()*3, vx:(Math.random()-0.5)*2,
      a:Math.random()*Math.PI, va:(Math.random()*0.2-0.1)
    });
  }
  let t=0;
  function step(){
    ctx.clearRect(0,0,w,h);
    parts.forEach(p=>{
      p.y+=p.vy; p.x+=p.vx; p.a+=p.va;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
      ctx.fillStyle= `hsl(${(p.x+p.y)%360},100%,60%)`;
      ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2);
      ctx.restore();
    });
    t++;
    if(t<120) requestAnimationFrame(step); else ctx.clearRect(0,0,w,h);
  }
  step();
}

/* Init */
function init(){
  renderProducts(); applyShipModeUI(); updateFab(); restoreForm();

  if(!sessionStorage.getItem('welcomeShown')){
    document.getElementById('discountPopup').style.display='flex';
    sessionStorage.setItem('welcomeShown','true');
  } else {
    document.getElementById('discountPopup').style.display='none';
  }
}
init();
</script>
</body>
</html>
